<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>JSON Data Mapper</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      line-height: 1.4;
      color: #333;
      background: #fff;
      overflow-x: hidden;
    }

    .container {
      padding: 16px;
      max-width: 100%;
    }

    header {
      margin-bottom: 20px;
      border-bottom: 1px solid #e5e5e5;
      padding-bottom: 12px;
    }

    h1 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    p {
      font-size: 11px;
      color: #666;
    }

    .data-source-section {
      margin-bottom: 20px;
    }

    .data-source-tabs {
      display: flex;
      border-bottom: 1px solid #e5e5e5;
      margin-bottom: 16px;
    }

    .data-source-tab {
      padding: 8px 16px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: #666;
      transition: all 0.2s ease;
    }

    .data-source-tab.active {
      color: #0066cc;
      border-bottom-color: #0066cc;
    }

    .data-source-tab:hover {
      color: #0066cc;
    }

    .data-source-content {
      min-height: 120px;
    }

    .upload-section {
      margin-bottom: 20px;
    }

    .api-section {
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #333;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 11px;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #0066cc;
    }

    .form-row {
      display: flex;
      gap: 8px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .fetch-button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .fetch-button:hover:not(:disabled) {
      background: #0052a3;
    }

    .fetch-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .loading {
      opacity: 0.7;
    }

    /* Value Builder Styles */
    .build-value-btn {
      background: #18a0fb;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 10px;
      cursor: pointer;
      margin-left: 8px;
      transition: background-color 0.2s ease;
    }

    .build-value-btn:hover {
      background: #0073e6;
    }

    .build-value-btn.active {
      background: #0066cc;
    }

    .clear-builder-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 10px;
      cursor: pointer;
      margin-left: 4px;
    }

    .clear-builder-btn:hover {
      background: #c0392b;
    }

    /* Configuration Save/Load Styles */
    .config-section {
      margin-bottom: 20px;
      padding: 12px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      background: #f8f9fa;
    }

    .config-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .config-btn {
      background: #0066cc;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .config-btn:hover:not(:disabled) {
      background: #0052a3;
    }

    .config-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .config-btn.danger {
      background: #e74c3c;
    }

    .config-btn.danger:hover:not(:disabled) {
      background: #c0392b;
    }

    .config-list {
      max-height: 100px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 3px;
      background: white;
    }

    .config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      border-bottom: 1px solid #e5e5e5;
      font-size: 11px;
    }

    .config-item:last-child {
      border-bottom: none;
    }

    .config-item:hover {
      background: #f0f8ff;
    }

    .config-name {
      flex: 1;
      font-weight: 500;
    }

    .config-meta {
      font-size: 10px;
      color: #666;
      margin-right: 8px;
    }

    .config-actions {
      display: flex;
      gap: 4px;
    }

    .config-action-btn {
      background: none;
      border: none;
      padding: 2px 4px;
      border-radius: 2px;
      font-size: 10px;
      cursor: pointer;
      color: #666;
    }

    .config-action-btn:hover {
      background: #e9ecef;
      color: #333;
    }

    .config-save-input {
      width: 100%;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 11px;
      margin-bottom: 8px;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: white;
      border-radius: 8px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e5e5;
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: #333;
    }

    .builder-part {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      padding: 8px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      background: #f8f9fa;
      cursor: move;
      transition: all 0.2s ease;
      position: relative;
    }

    .builder-part:hover {
      background: #e9ecef;
      border-color: #0066cc;
    }

    .builder-part.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .builder-part.drag-over {
      border-color: #18a0fb;
      background: #f0f8ff;
      transform: translateY(-2px);
    }

    .builder-part select,
    .builder-part input {
      flex: 1;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 11px;
    }

    .remove-part-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 4px 6px;
      border-radius: 3px;
      font-size: 10px;
      cursor: pointer;
      min-width: 20px;
    }

    .remove-part-btn:hover {
      background: #c0392b;
    }

    .reorder-controls {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-right: 8px;
    }

    .reorder-btn {
      background: #0066cc;
      color: white;
      border: none;
      padding: 2px 4px;
      border-radius: 2px;
      font-size: 10px;
      cursor: pointer;
      width: 20px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .reorder-btn:hover:not(:disabled) {
      background: #0052a3;
    }

    .reorder-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .drag-handle {
      color: #999;
      font-size: 12px;
      margin-right: 4px;
      cursor: move;
      padding: 2px;
    }

    .drag-handle:hover {
      color: #666;
    }

    .add-part-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .add-part-btn {
      background: #0066cc;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }

    .add-part-btn:hover {
      background: #0052a3;
    }

    .preview-section {
      margin: 16px 0;
      padding: 12px;
      background: #f0f8ff;
      border-radius: 4px;
      border: 1px solid #0066cc;
    }

    .preview-label {
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #333;
    }

    .preview-value {
      font-size: 12px;
      font-family: monospace;
      background: white;
      padding: 6px 8px;
      border-radius: 3px;
      border: 1px solid #ccc;
      word-break: break-all;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e5e5e5;
    }

    .modal-btn {
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }

    .modal-btn.primary {
      background: #18a0fb;
      color: white;
    }

    .modal-btn.primary:hover {
      background: #0073e6;
    }

    .modal-btn.secondary {
      background: #f8f9fa;
      color: #333;
      border: 1px solid #ccc;
    }

    .modal-btn.secondary:hover {
      background: #e9ecef;
    }

    .drop-zone {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .drop-zone:hover,
    .drop-zone.dragging {
      border-color: #0066cc;
      background-color: #f0f8ff;
    }

    .file-button {
      display: inline-block;
      background: #0066cc;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 8px 0;
      font-size: 11px;
      font-weight: 500;
    }

    .file-button:hover {
      background: #0052a3;
    }

    .file-limit {
      font-size: 10px;
      color: #999;
    }

    .json-preview {
      margin-bottom: 20px;
    }

    .table-container {
      max-height: 200px;
      overflow: auto;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
    }

    th, td {
      border: 1px solid #e5e5e5;
      padding: 4px 6px;
      text-align: left;
      min-width: 60px;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    .mapping-section {
      margin-bottom: 20px;
    }

    .mapping-table {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
    }

    .mapping-row {
      display: flex;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #e5e5e5;
      gap: 8px;
    }

    .mapping-row:last-child {
      border-bottom: none;
    }

    .mapping-row label {
      flex: 1;
      font-size: 11px;
      font-weight: 500;
      min-width: 80px;
      word-break: break-word;
    }

    .mapping-row input {
      flex: 1;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 11px;
      min-width: 100px;
    }

    .mapping-row input:focus {
      outline: none;
      border-color: #0066cc;
    }

    .action-section {
      margin-bottom: 20px;
    }

    .apply-button {
      width: 100%;
      background: #18a0fb;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .apply-button:hover:not(:disabled) {
      background: #0073e6;
    }

    .apply-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .logs-section {
      border-top: 1px solid #e5e5e5;
      padding-top: 16px;
    }

    .logs-container {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      background: #f8f9fa;
    }

    .log-entry {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e5e5;
      font-size: 10px;
      display: flex;
      gap: 8px;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-entry.info {
      color: #333;
    }

    .log-entry.warning {
      color: #f39c12;
      background: #fef9e7;
    }

    .log-entry.error {
      color: #e74c3c;
      background: #fdf2f2;
    }

    .timestamp {
      color: #666;
      font-size: 9px;
      min-width: 60px;
    }

    .message {
      flex: 1;
      word-break: break-word;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #999;
    }
  </style>
</head>
<body>
  <div id="react-page"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useCallback, useEffect } = React;

    // Helper function to extract all possible key paths from JSON data
    function extractJsonKeys(data, maxDepth = 3) {
      const keys = new Set();
      
      function extractKeysRecursive(obj, prefix = '', depth = 0) {
        if (depth >= maxDepth || obj === null || typeof obj !== 'object') {
          return;
        }
        
        for (const key in obj) {
          if (obj.hasOwnProperty(key)) {
            const fullKey = prefix ? `${prefix}.${key}` : key;
            keys.add(fullKey);
            
            if (typeof obj[key] === 'object' && obj[key] !== null) {
              if (Array.isArray(obj[key])) {
                // For arrays, examine the first few items to extract their keys
                const arrayItems = obj[key].slice(0, 3); // Check first 3 items
                arrayItems.forEach((item, index) => {
                  if (typeof item === 'object' && item !== null) {
                    // Add both indexed and non-indexed paths
                    extractKeysRecursive(item, `${fullKey}[${index}]`, depth + 1);
                    extractKeysRecursive(item, `${fullKey}[]`, depth + 1);
                  }
                });
              } else {
                // Regular object
                extractKeysRecursive(obj[key], fullKey, depth + 1);
              }
            }
          }
        }
      }
      
      data.slice(0, 10).forEach(item => extractKeysRecursive(item));
      return Array.from(keys).sort();
    }

    // Helper function to generate smart default layer names
    function getDefaultLayerName(jsonKey) {
      // For array keys like "encounters[0].encounter_id", use the final property name
      if (jsonKey.includes('[') && jsonKey.includes('.')) {
        return jsonKey.split('.').pop(); // Get the last part after the dot
      }
      
      // For array keys like "encounters[]", use the base name
      if (jsonKey.includes('[')) {
        return jsonKey.split('[')[0];
      }
      
      // For nested keys like "user.profile.name", use the final property name
      if (jsonKey.includes('.')) {
        return jsonKey.split('.').pop();
      }
      
      // For simple keys, use as-is
      return jsonKey;
    }

    // Helper function to get nested value for preview
    function getNestedValue(obj, path) {
      const parts = path.split('.');
      
      return parts.reduce((current, part) => {
        if (current === null || current === undefined) return undefined;
        
        // Handle array indexing like "encounters[0]" or "encounters[]"
        const arrayMatch = part.match(/^(.+)\[(\d*)\]$/);
        if (arrayMatch) {
          const [, arrayKey, index] = arrayMatch;
          const arrayValue = current[arrayKey];
          
          if (!Array.isArray(arrayValue)) return undefined;
          
          if (index === '') {
            // Return first item for "[]" notation
            return arrayValue[0];
          } else {
            // Return specific index
            return arrayValue[parseInt(index)];
          }
        }
        
        return current[part];
      }, obj);
    }

    const JsonDataMapper = () => {
      const [jsonData, setJsonData] = useState(null);
      const [jsonKeys, setJsonKeys] = useState([]);
      const [mappings, setMappings] = useState([]);
      const [selectionCount, setSelectionCount] = useState(0);
      const [logs, setLogs] = useState([]);
      const [isDragging, setIsDragging] = useState(false);
      
      // Data source state
      const [dataSource, setDataSource] = useState('file'); // 'file' | 'api' | 'manual'
      const [apiConfig, setApiConfig] = useState({
        url: '',
        method: 'GET',
        headers: {},
        apiKey: '',
        authType: 'none' // 'none' | 'bearer' | 'apikey' | 'basic'
      });
      const [isLoadingData, setIsLoadingData] = useState(false);
      
      // Configuration state
      const [savedConfigs, setSavedConfigs] = useState([]);
      const [showConfigSave, setShowConfigSave] = useState(false);
      const [configName, setConfigName] = useState('');
      const [showConfigList, setShowConfigList] = useState(false);
      
      // Value builder state
      const [valueBuilderModal, setValueBuilderModal] = useState({ 
        isOpen: false, 
        mappingKey: null 
      });
      const [currentBuilder, setCurrentBuilder] = useState({
        parts: [{ type: 'key', value: '' }] // Array of {type: 'key'|'text', value: string}
      });

      // Modular data processing function
      const processJsonData = useCallback((parsed, source = 'unknown') => {
        try {
          let dataArray;
          
          // Debug logging
          addLog(`Parsed JSON type: ${Array.isArray(parsed) ? 'array' : typeof parsed}`, 'info');
          
          if (Array.isArray(parsed)) {
            dataArray = parsed;
            addLog('Using direct array', 'info');
          } else if (typeof parsed === 'object' && parsed !== null) {
            // Check if the object has a single property that contains an array
            const keys = Object.keys(parsed);
            addLog(`Object has ${keys.length} keys: ${keys.join(', ')}`, 'info');
            
            if (keys.length === 1 && Array.isArray(parsed[keys[0]])) {
              // Single array property - use the array
              dataArray = parsed[keys[0]];
              addLog(`Found array data in property "${keys[0]}" with ${dataArray.length} items`, 'info');
            } else {
              // Check if any property contains an array
              const arrayProperty = keys.find(key => Array.isArray(parsed[key]));
              if (arrayProperty) {
                // Multiple properties with one array - merge metadata with array items
                const arrayData = parsed[arrayProperty];
                const metadata = {};
                
                // Extract non-array properties as metadata
                keys.forEach(key => {
                  if (key !== arrayProperty) {
                    metadata[key] = parsed[key];
                  }
                });
                
                // Merge metadata into each array item
                dataArray = arrayData.map(item => ({
                  ...metadata,
                  ...item
                }));
                
                addLog(`Merged ${Object.keys(metadata).length} metadata keys with ${arrayData.length} array items from "${arrayProperty}"`, 'info');
              } else {
                dataArray = [parsed];
                addLog('No arrays found, wrapping object in array', 'info');
              }
            }
          } else {
            dataArray = [parsed];
            addLog('Wrapping primitive value in array', 'info');
          }
          
          setJsonData(dataArray);
          const keys = extractJsonKeys(dataArray);
          setJsonKeys(keys);
          
          // Initialize mappings with smart default layer names
          setMappings(keys.map(key => ({ 
            jsonKey: key, 
            layerName: getDefaultLayerName(key),
            valueBuilder: null // null = use direct key, object = custom builder
          })));
          
          addLog(`Loaded JSON from ${source} with ${dataArray.length} objects and ${keys.length} unique keys`, 'info');
          return true;
        } catch (error) {
          addLog(`Invalid JSON data from ${source}`, 'error');
          console.error('JSON parsing error:', error);
          return false;
        }
      }, []);

      // Handle file upload
      const handleFileUpload = useCallback((file) => {
        if (file.size > 2 * 1024 * 1024) { // 2MB limit
          addLog('File size exceeds 2MB limit', 'error');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          const content = e.target?.result;
          const parsed = JSON.parse(content);
          processJsonData(parsed, 'file');
        };
        reader.readAsText(file);
      }, [processJsonData]);

      // Handle API data fetching
      const handleApiDataFetch = useCallback(async () => {
        if (!apiConfig.url) {
          addLog('API URL is required', 'error');
          return;
        }

        setIsLoadingData(true);
        addLog(`Fetching data from API: ${apiConfig.url}`, 'info');

        try {
          // Build headers
          const headers = { ...apiConfig.headers };
          
          // Add authentication
          if (apiConfig.authType === 'bearer' && apiConfig.apiKey) {
            headers['Authorization'] = `Bearer ${apiConfig.apiKey}`;
          } else if (apiConfig.authType === 'apikey' && apiConfig.apiKey) {
            headers['X-API-Key'] = apiConfig.apiKey;
          }
          
          // Set content type for non-GET requests
          if (apiConfig.method !== 'GET') {
            headers['Content-Type'] = 'application/json';
          }

          const response = await fetch(apiConfig.url, {
            method: apiConfig.method,
            headers
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          processJsonData(data, 'API');
          
        } catch (error) {
          addLog(`API fetch failed: ${error.message}`, 'error');
          console.error('API fetch error:', error);
        } finally {
          setIsLoadingData(false);
        }
      }, [apiConfig, processJsonData]);

      // Handle drag and drop
      const handleDragOver = useCallback((e) => {
        e.preventDefault();
        setIsDragging(true);
      }, []);

      const handleDragLeave = useCallback((e) => {
        e.preventDefault();
        setIsDragging(false);
      }, []);

      const handleDrop = useCallback((e) => {
        e.preventDefault();
        setIsDragging(false);
        
        const files = Array.from(e.dataTransfer.files);
        const jsonFile = files.find(file => file.type === 'application/json' || file.name.endsWith('.json'));
        
        if (jsonFile) {
          handleFileUpload(jsonFile);
        } else {
          addLog('Please drop a JSON file', 'error');
        }
      }, [handleFileUpload]);

      // Handle file input change
      const handleFileInputChange = useCallback((e) => {
        const file = e.target.files?.[0];
        if (file) {
          handleFileUpload(file);
        }
      }, [handleFileUpload]);

      // Update mapping
      const updateMapping = useCallback((jsonKey, layerName) => {
        setMappings(prev => prev.map(mapping => 
          mapping.jsonKey === jsonKey 
            ? { ...mapping, layerName }
            : mapping
        ));
      }, []);

      // Add log entry
      const addLog = useCallback((message, level = 'info') => {
        setLogs(prev => [...prev, {
          message,
          level,
          timestamp: new Date().toLocaleTimeString()
        }]);
      }, []);

      // Apply data
      const handleApplyData = useCallback(() => {
        if (!jsonData || jsonData.length === 0) {
          addLog('No JSON data loaded', 'error');
          return;
        }

        const activeMappings = mappings.filter(m => m.layerName.trim() !== '');
        if (activeMappings.length === 0) {
          addLog('No layer mappings configured', 'error');
          return;
        }

        if (selectionCount === 0) {
          addLog('No layers selected in Figma', 'error');
          return;
        }

        // Process mappings with value builders
        const processedMappings = activeMappings.map(mapping => ({
          ...mapping,
          useValueBuilder: !!mapping.valueBuilder
        }));

        parent.postMessage({
          pluginMessage: {
            type: 'apply-data',
            jsonData,
            mappings: processedMappings,
            valueBuilders: activeMappings.reduce((acc, mapping) => {
              if (mapping.valueBuilder) {
                acc[mapping.jsonKey] = mapping.valueBuilder;
              }
              return acc;
            }, {})
          }
        }, '*');
      }, [jsonData, mappings, selectionCount]);

      // Clear all data
      const handleClearData = useCallback(() => {
        setJsonData(null);
        setJsonKeys([]);
        setMappings([]);
        addLog('Data cleared', 'info');
      }, []);

      // Value builder functions
      const buildValue = useCallback((parts, dataItem) => {
        return parts.map(part => {
          if (part.type === 'text') {
            return part.value;
          } else if (part.type === 'key') {
            return getNestedValue(dataItem, part.value) || '';
          }
          return '';
        }).join('');
      }, []);

      const getValueForMapping = useCallback((mapping, dataItem) => {
        if (mapping.valueBuilder) {
          return buildValue(mapping.valueBuilder.parts, dataItem);
        }
        return getNestedValue(dataItem, mapping.jsonKey);
      }, [buildValue]);

      // Value builder modal handlers
      const openValueBuilder = useCallback((mappingKey) => {
        const mapping = mappings.find(m => m.jsonKey === mappingKey);
        if (mapping && mapping.valueBuilder) {
          setCurrentBuilder(mapping.valueBuilder);
        } else {
          setCurrentBuilder({
            parts: [{ type: 'key', value: mappingKey }]
          });
        }
        setValueBuilderModal({ isOpen: true, mappingKey });
      }, [mappings]);

      const closeValueBuilder = useCallback(() => {
        setValueBuilderModal({ isOpen: false, mappingKey: null });
        setCurrentBuilder({ parts: [{ type: 'key', value: '' }] });
      }, []);

      const saveValueBuilder = useCallback(() => {
        if (!valueBuilderModal.mappingKey) return;
        
        setMappings(prev => prev.map(mapping => 
          mapping.jsonKey === valueBuilderModal.mappingKey
            ? { ...mapping, valueBuilder: { ...currentBuilder } }
            : mapping
        ));
        
        addLog(`Value builder saved for "${valueBuilderModal.mappingKey}"`, 'info');
        closeValueBuilder();
      }, [valueBuilderModal.mappingKey, currentBuilder, closeValueBuilder]);

      const addBuilderPart = useCallback((type) => {
        setCurrentBuilder(prev => ({
          ...prev,
          parts: [...prev.parts, { type, value: '' }]
        }));
      }, []);

      const updateBuilderPart = useCallback((index, field, value) => {
        setCurrentBuilder(prev => ({
          ...prev,
          parts: prev.parts.map((part, i) => 
            i === index ? { ...part, [field]: value } : part
          )
        }));
      }, []);

      const removeBuilderPart = useCallback((index) => {
        setCurrentBuilder(prev => ({
          ...prev,
          parts: prev.parts.filter((_, i) => i !== index)
        }));
      }, []);

      const clearValueBuilder = useCallback((mappingKey) => {
        setMappings(prev => prev.map(mapping => 
          mapping.jsonKey === mappingKey
            ? { ...mapping, valueBuilder: null }
            : mapping
        ));
        addLog(`Value builder cleared for "${mappingKey}"`, 'info');
      }, []);

      // Reordering functions
      const moveBuilderPart = useCallback((fromIndex, toIndex) => {
        setCurrentBuilder(prev => {
          const newParts = [...prev.parts];
          const [movedItem] = newParts.splice(fromIndex, 1);
          newParts.splice(toIndex, 0, movedItem);
          return { ...prev, parts: newParts };
        });
      }, []);

      const movePartUp = useCallback((index) => {
        if (index > 0) {
          moveBuilderPart(index, index - 1);
        }
      }, [moveBuilderPart]);

      const movePartDown = useCallback((index) => {
        if (index < currentBuilder.parts.length - 1) {
          moveBuilderPart(index, index + 1);
        }
      }, [moveBuilderPart, currentBuilder.parts.length]);

      // Drag and drop handlers
      const handleDragStart = useCallback((e, index) => {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', index.toString());
        e.target.style.opacity = '0.5';
      }, []);

      const handleDragEnd = useCallback((e) => {
        e.target.style.opacity = '1';
      }, []);

      const handleBuilderDragOver = useCallback((e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      }, []);

      const handleBuilderDrop = useCallback((e, dropIndex) => {
        e.preventDefault();
        const dragIndex = parseInt(e.dataTransfer.getData('text/plain'));
        if (dragIndex !== dropIndex) {
          moveBuilderPart(dragIndex, dropIndex);
        }
      }, [moveBuilderPart]);

      // Configuration save/load functions
      const saveConfiguration = useCallback((name) => {
        if (!name.trim()) {
          addLog('Configuration name is required', 'error');
          return;
        }

        const config = {
          name: name.trim(),
          timestamp: new Date().toISOString(),
          dataSource,
          apiConfig: dataSource === 'api' ? apiConfig : null,
          mappings: mappings.map(m => ({
            jsonKey: m.jsonKey,
            layerName: m.layerName,
            valueBuilder: m.valueBuilder
          })),
          jsonKeys
        };

        // Send save request to main thread
        parent.postMessage({
          pluginMessage: {
            type: 'save-config',
            data: config
          }
        }, '*');
        
        setConfigName('');
        setShowConfigSave(false);
      }, [dataSource, apiConfig, mappings, jsonKeys]);

      const loadConfiguration = useCallback((config) => {
        try {
          // Restore data source and API config
          setDataSource(config.dataSource || 'file');
          if (config.apiConfig) {
            setApiConfig(config.apiConfig);
          }
          
          // Restore mappings
          if (config.mappings && config.mappings.length > 0) {
            setMappings(config.mappings);
            addLog(`Loaded ${config.mappings.length} key mappings`, 'info');
          }
          
          // Restore JSON keys if available
          if (config.jsonKeys && config.jsonKeys.length > 0) {
            setJsonKeys(config.jsonKeys);
          }
          
          addLog(`Configuration "${config.name}" loaded successfully`, 'info');
          setShowConfigList(false);
        } catch (error) {
          addLog('Failed to load configuration', 'error');
          console.error('Config load error:', error);
        }
      }, []);

      const deleteConfiguration = useCallback((configName) => {
        // Send delete request to main thread
        parent.postMessage({
          pluginMessage: {
            type: 'delete-config',
            configName: configName
          }
        }, '*');
      }, []);

      const clearAllConfigurations = useCallback(() => {
        if (confirm('Delete all saved configurations? This cannot be undone.')) {
          // Send clear request to main thread
          parent.postMessage({
            pluginMessage: {
              type: 'clear-configs'
            }
          }, '*');
        }
      }, []);

      // Request configurations from main thread on component mount
      useEffect(() => {
        parent.postMessage({
          pluginMessage: {
            type: 'load-configs'
          }
        }, '*');
      }, []);

      // Listen for messages from main thread
      useEffect(() => {
        const handleMessage = (event) => {
          const { type, message, level, selectionCount: count, data } = event.data.pluginMessage || {};
          
          if (type === 'log') {
            addLog(message, level);
          } else if (type === 'selection-changed') {
            setSelectionCount(count);
          } else if (type === 'configs-loaded') {
            setSavedConfigs(data || []);
          } else if (type === 'config-saved') {
            setSavedConfigs(data || []);
            addLog(message, 'info');
          } else if (type === 'config-deleted') {
            setSavedConfigs(data || []);
            addLog(message, 'info');
          } else if (type === 'configs-cleared') {
            setSavedConfigs([]);
            addLog(message, 'info');
          } else if (type === 'storage-error') {
            addLog(message, 'error');
          }
        };

        window.addEventListener('message', handleMessage);
        return () => window.removeEventListener('message', handleMessage);
      }, [addLog]);

      // Render JSON preview table
      const renderJsonPreview = () => {
        if (!jsonData || jsonData.length === 0) return null;

        const previewData = jsonData.slice(0, 10);
        const displayKeys = jsonKeys.slice(0, 15); // Limit columns for display

        return (
          <div className="json-preview">
            <h3>JSON Preview (first 10 rows)</h3>
            <div className="table-container">
              <table>
                <thead>
                  <tr>
                    {displayKeys.map(key => (
                      <th key={key}>{key}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {previewData.map((item, index) => (
                    <tr key={index}>
                      {displayKeys.map(key => (
                        <td key={key}>
                          {String(getNestedValue(item, key) || '').substring(0, 50)}
                          {String(getNestedValue(item, key) || '').length > 50 ? '...' : ''}
                        </td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      };

      return (
        <div className="container">
          <header>
            <h1>JSON Data Mapper</h1>
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
              <p>Selected: {selectionCount} layer(s)</p>
              {jsonData && (
                <button 
                  onClick={handleClearData}
                  style={{
                    background: '#e74c3c', 
                    color: 'white', 
                    border: 'none', 
                    padding: '4px 8px', 
                    borderRadius: '3px', 
                    fontSize: '10px',
                    cursor: 'pointer'
                  }}
                >
                  🗑️ Clear
                </button>
              )}
            </div>
          </header>

          <section className="data-source-section">
            <div className="data-source-tabs">
              <button 
                className={`data-source-tab ${dataSource === 'file' ? 'active' : ''}`}
                onClick={() => setDataSource('file')}
              >
                📁 JSON File
              </button>
              <button 
                className={`data-source-tab ${dataSource === 'api' ? 'active' : ''}`}
                onClick={() => setDataSource('api')}
              >
                🌐 API
              </button>
              <button 
                className={`data-source-tab ${dataSource === 'manual' ? 'active' : ''}`}
                onClick={() => setDataSource('manual')}
                disabled
                style={{ opacity: 0.5, cursor: 'not-allowed' }}
              >
                ✏️ Manual (Soon)
              </button>
            </div>

            <div className="data-source-content">
              {dataSource === 'file' && (
                <div className="upload-section">
                  <div 
                    className={`drop-zone ${isDragging ? 'dragging' : ''}`}
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop}
                  >
                    <p>Drop JSON file here or</p>
                    <label className="file-button">
                      Choose File
                      <input
                        type="file"
                        accept=".json,application/json"
                        onChange={handleFileInputChange}
                        style={{ display: 'none' }}
                      />
                    </label>
                    <p className="file-limit">Max 2MB</p>
                  </div>
                </div>
              )}

              {dataSource === 'api' && (
                <div className="api-section">
                  <div className="form-group">
                    <label>API URL *</label>
                    <input
                      type="url"
                      placeholder="https://api.example.com/data"
                      value={apiConfig.url}
                      onChange={(e) => setApiConfig(prev => ({ ...prev, url: e.target.value }))}
                    />
                  </div>

                  <div className="form-row">
                    <div className="form-group">
                      <label>Method</label>
                      <select
                        value={apiConfig.method}
                        onChange={(e) => setApiConfig(prev => ({ ...prev, method: e.target.value }))}
                      >
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                      </select>
                    </div>
                    <div className="form-group">
                      <label>Authentication</label>
                      <select
                        value={apiConfig.authType}
                        onChange={(e) => setApiConfig(prev => ({ ...prev, authType: e.target.value }))}
                      >
                        <option value="none">None</option>
                        <option value="bearer">Bearer Token</option>
                        <option value="apikey">API Key</option>
                      </select>
                    </div>
                  </div>

                  {(apiConfig.authType === 'bearer' || apiConfig.authType === 'apikey') && (
                    <div className="form-group">
                      <label>
                        {apiConfig.authType === 'bearer' ? 'Bearer Token' : 'API Key'}
                      </label>
                      <input
                        type="password"
                        placeholder={`Enter your ${apiConfig.authType === 'bearer' ? 'bearer token' : 'API key'}`}
                        value={apiConfig.apiKey}
                        onChange={(e) => setApiConfig(prev => ({ ...prev, apiKey: e.target.value }))}
                      />
                    </div>
                  )}

                  <button
                    className={`fetch-button ${isLoadingData ? 'loading' : ''}`}
                    onClick={handleApiDataFetch}
                    disabled={!apiConfig.url || isLoadingData}
                  >
                    {isLoadingData ? '⏳ Fetching...' : '🚀 Fetch Data'}
                  </button>
                </div>
              )}
            </div>
          </section>

          {/* Configuration Section */}
          <section className="config-section">
            <h3>💾 Configuration</h3>
            <div className="config-controls">
              <button
                className="config-btn"
                onClick={() => setShowConfigSave(!showConfigSave)}
                disabled={!jsonData || mappings.length === 0}
                title="Save current mapping configuration"
              >
                💾 Save Config
              </button>
              <button
                className="config-btn"
                onClick={() => setShowConfigList(!showConfigList)}
                disabled={savedConfigs.length === 0}
                title="Load saved configuration"
              >
                📁 Load Config ({savedConfigs.length})
              </button>
              {savedConfigs.length > 0 && (
                <button
                  className="config-btn danger"
                  onClick={clearAllConfigurations}
                  title="Delete all saved configurations"
                >
                  🗑️ Clear All
                </button>
              )}
            </div>

            {showConfigSave && (
              <div>
                <input
                  type="text"
                  className="config-save-input"
                  placeholder="Enter configuration name..."
                  value={configName}
                  onChange={(e) => setConfigName(e.target.value)}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter' && configName.trim()) {
                      saveConfiguration(configName);
                    }
                  }}
                />
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button
                    className="config-btn"
                    onClick={() => saveConfiguration(configName)}
                    disabled={!configName.trim()}
                  >
                    💾 Save
                  </button>
                  <button
                    className="config-btn"
                    onClick={() => {
                      setShowConfigSave(false);
                      setConfigName('');
                    }}
                  >
                    Cancel
                  </button>
                </div>
              </div>
            )}

            {showConfigList && savedConfigs.length > 0 && (
              <div className="config-list">
                {savedConfigs.map((config, index) => (
                  <div key={index} className="config-item">
                    <div className="config-name">{config.name}</div>
                    <div className="config-meta">
                      {config.mappings?.length || 0} mappings • {new Date(config.timestamp).toLocaleDateString()}
                    </div>
                    <div className="config-actions">
                      <button
                        className="config-action-btn"
                        onClick={() => loadConfiguration(config)}
                        title="Load this configuration"
                      >
                        📁 Load
                      </button>
                      <button
                        className="config-action-btn"
                        onClick={() => deleteConfiguration(config.name)}
                        title="Delete this configuration"
                      >
                        🗑️
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </section>

          {jsonData && (
            <>
              {renderJsonPreview()}
              
              <section className="mapping-section">
                <h3>Key Mapping</h3>
                <div className="mapping-table">
                  {mappings.map(mapping => (
                    <div key={mapping.jsonKey} className="mapping-row">
                      <label>{mapping.jsonKey}</label>
                      <input
                        type="text"
                        placeholder="Figma layer name"
                        value={mapping.layerName}
                        onChange={(e) => updateMapping(mapping.jsonKey, e.target.value)}
                      />
                      <button
                        className={`build-value-btn ${mapping.valueBuilder ? 'active' : ''}`}
                        onClick={() => openValueBuilder(mapping.jsonKey)}
                        title="Build custom value from multiple keys"
                      >
                        {mapping.valueBuilder ? '🔧 Edit' : '🔨 Build'}
                      </button>
                      {mapping.valueBuilder && (
                        <button
                          className="clear-builder-btn"
                          onClick={() => clearValueBuilder(mapping.jsonKey)}
                          title="Clear value builder"
                        >
                          ✕
                        </button>
                      )}
                    </div>
                  ))}
                </div>
              </section>

              <section className="action-section">
                <button 
                  className="apply-button"
                  onClick={handleApplyData}
                  disabled={selectionCount === 0}
                >
                  Apply Data to Selection
                </button>
              </section>
            </>
          )}

          <section className="logs-section">
            <h3>Logs</h3>
            <div className="logs-container">
              {logs.map((log, index) => (
                <div key={index} className={`log-entry ${log.level}`}>
                  <span className="timestamp">{log.timestamp}</span>
                  <span className="message">{log.message}</span>
                </div>
              ))}
            </div>
          </section>

          {/* Value Builder Modal */}
          {valueBuilderModal.isOpen && (
            <div className="modal-overlay" onClick={closeValueBuilder}>
              <div className="modal" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                  <h3 className="modal-title">
                    Build Value for "{valueBuilderModal.mappingKey}"
                  </h3>
                  <button className="modal-close" onClick={closeValueBuilder}>
                    ×
                  </button>
                </div>

                <div style={{
                  fontSize: '11px', 
                  color: '#666', 
                  marginBottom: '16px', 
                  padding: '8px 12px', 
                  background: '#f8f9fa', 
                  borderRadius: '4px',
                  borderLeft: '3px solid #0066cc'
                }}>
                  💡 <strong>Tip:</strong> Drag the ⋮⋮ handle or use ▲▼ buttons to reorder parts. The preview shows your combined result.
                </div>

                <div className="add-part-buttons">
                  <button
                    className="add-part-btn"
                    onClick={() => addBuilderPart('key')}
                  >
                    + Add JSON Key
                  </button>
                  <button
                    className="add-part-btn"
                    onClick={() => addBuilderPart('text')}
                  >
                    + Add Text
                  </button>
                </div>

                <div className="builder-parts">
                  {currentBuilder.parts.map((part, index) => (
                    <div 
                      key={index} 
                      className="builder-part"
                      draggable="true"
                      onDragStart={(e) => handleDragStart(e, index)}
                      onDragEnd={handleDragEnd}
                      onDragOver={handleBuilderDragOver}
                      onDrop={(e) => handleBuilderDrop(e, index)}
                    >
                      <div className="drag-handle" title="Drag to reorder">
                        ⋮⋮
                      </div>
                      
                      <div className="reorder-controls">
                        <button
                          className="reorder-btn"
                          onClick={() => movePartUp(index)}
                          disabled={index === 0}
                          title="Move up"
                        >
                          ▲
                        </button>
                        <button
                          className="reorder-btn"
                          onClick={() => movePartDown(index)}
                          disabled={index === currentBuilder.parts.length - 1}
                          title="Move down"
                        >
                          ▼
                        </button>
                      </div>

                      <select
                        value={part.type}
                        onChange={(e) => updateBuilderPart(index, 'type', e.target.value)}
                      >
                        <option value="key">JSON Key</option>
                        <option value="text">Text</option>
                      </select>
                      
                      {part.type === 'key' ? (
                        <select
                          value={part.value}
                          onChange={(e) => updateBuilderPart(index, 'value', e.target.value)}
                        >
                          <option value="">Select a key...</option>
                          {jsonKeys.map(key => (
                            <option key={key} value={key}>{key}</option>
                          ))}
                        </select>
                      ) : (
                        <input
                          type="text"
                          placeholder="Enter text..."
                          value={part.value}
                          onChange={(e) => updateBuilderPart(index, 'value', e.target.value)}
                        />
                      )}
                      
                      {currentBuilder.parts.length > 1 && (
                        <button
                          className="remove-part-btn"
                          onClick={() => removeBuilderPart(index)}
                          title="Remove this part"
                        >
                          ×
                        </button>
                      )}
                    </div>
                  ))}
                </div>

                {jsonData && jsonData.length > 0 && (
                  <div className="preview-section">
                    <div className="preview-label">Preview (using first data item):</div>
                    <div className="preview-value">
                      {buildValue(currentBuilder.parts, jsonData[0]) || '(empty)'}
                    </div>
                  </div>
                )}

                <div className="modal-actions">
                  <button
                    className="modal-btn secondary"
                    onClick={closeValueBuilder}
                  >
                    Cancel
                  </button>
                  <button
                    className="modal-btn primary"
                    onClick={saveValueBuilder}
                  >
                    Save Value Builder
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Render the app
    ReactDOM.render(<JsonDataMapper />, document.getElementById('react-page'));
  </script>
</body>
</html>