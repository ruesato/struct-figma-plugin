"use strict";var z=Object.defineProperty,B=Object.defineProperties;var K=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var O=Object.prototype.hasOwnProperty,j=Object.prototype.propertyIsEnumerable;var E=(e,t,a)=>t in e?z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,$=(e,t)=>{for(var a in t||(t={}))O.call(t,a)&&E(e,a,t[a]);if(P)for(var a of P(t))j.call(t,a)&&E(e,a,t[a]);return e},M=(e,t)=>B(e,K(t));var f=(e,t,a)=>new Promise((r,i)=>{var c=l=>{try{g(a.next(l))}catch(o){i(o)}},s=l=>{try{g(a.throw(l))}catch(o){i(o)}},g=l=>l.done?r(l.value):Promise.resolve(l.value).then(c,s);g((a=a.apply(e,t)).next())});const J=[/authorization/i,/auth/i,/token/i,/key/i,/secret/i,/bearer/i,/api[_-]?key/i,/x-api[_-]?key/i,/access[_-]?token/i,/refresh[_-]?token/i,/session[_-]?token/i,/csrf[_-]?token/i,/jwt/i,/oauth/i,/credential/i,/password/i,/passwd/i,/pwd/i];function I(e){return J.some(t=>t.test(e))}function Z(e){const t={};for(const[a,r]of Object.entries(e||{}))I(a)||(t[a]=r);return t}function X(e){return M($({},e),{apiKey:"",headers:Z(e.headers)})}function G(e){const{apiConfig:t}=e;return!!(t.apiKey&&t.apiKey.trim()!==""||Object.keys(t.headers||{}).some(r=>I(r)))}function Q(e){return M($({},e),{apiConfig:X(e.apiConfig)})}function Y(e){const t=[];let a=0,r=0,i=0;for(const c of e)if(G(c)){c.apiConfig.apiKey&&c.apiConfig.apiKey.trim()!==""&&r++;const s=Object.keys(c.apiConfig.headers||{}).filter(g=>I(g));i+=s.length,a++,t.push(Q(c))}else t.push(c);return{cleanedConfigurations:t,migrationSummary:{totalConfigs:e.length,migratedConfigs:a,removedApiKeys:r,removedHeaders:i}}}function x(e){if(!e||typeof e!="string")return"";const t=e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),a=5e4;return t.length>a?t.substring(0,a):t}function ee(e){if(!e||typeof e!="string")return!1;try{const t=/^https:\/\/([a-zA-Z0-9.-]+)(?::\d+)?(?:\/.*)?$/,a=e.match(t);if(!a)return!1;const r=a[1].toLowerCase();return!(r==="localhost"||r.startsWith("127.")||r.startsWith("192.168.")||r.startsWith("10.")||r.match(/^172\.(1[6-9]|2[0-9]|3[01])\./)||/^\d+\.\d+\.\d+\.\d+$/.test(r))}catch(t){return!1}}class A{static isAllowed(t){const a=Date.now(),r=a-this.WINDOW_MS;this.requestHistory=this.requestHistory.filter(s=>s.timestamp>r);const i=this.extractDomain(t);return this.requestHistory.filter(s=>this.extractDomain(s.url)===i).length>=this.MAX_REQUESTS?!1:(this.requestHistory.push({url:t,timestamp:a}),!0)}static extractDomain(t){try{const a=t.match(/^https?:\/\/([a-zA-Z0-9.-]+)/);if(a&&a[1]){let r=a[1].toLowerCase();return r.includes("..")||r.startsWith(".")||r.endsWith(".")?"invalid":r}return"unknown"}catch(a){return"unknown"}}}A.requestHistory=[],A.MAX_REQUESTS=25,A.WINDOW_MS=6e4;function T(e,t){return t.split(".").reduce((r,i)=>{if(r==null)return;const c=i.match(/^(.+)\[(\d*)\]$/);if(c){const[,s,g]=c,l=r[s];return Array.isArray(l)?g===""?l[0]:l[parseInt(g)]:void 0}return r[i]},e)}function D(e,t){if(e.name===t)return e;if("children"in e)for(const a of e.children){const r=D(a,t);if(r)return r}return null}function L(e){const t=[];if(e.type==="INSTANCE"&&t.push(e),"children"in e)for(const a of e.children)t.push(...L(a));return t}function te(e){const t=[];for(const a of e)if(a.type==="INSTANCE")t.push(a);else{const r=L(a);t.push(...r)}return t}function ae(e,t){try{const a=x(String(t));figma.loadFontAsync(e.fontName).then(()=>{e.characters=a,n(`\u{1F512} Applied sanitized text content (${a.length} chars)`,"info")})}catch(a){n("Failed to apply text content","error")}}const re=["jsonplaceholder.typicode.com","api.github.com","httpbin.org","images.unsplash.com","via.placeholder.com","picsum.photos","loremflickr.com","dummyimage.com"];function b(e){try{const t=e.match(/^https?:\/\/([a-zA-Z0-9.-]+)/);return t?t[1]:null}catch(t){return null}}function F(e){try{if(!/^https:\/\/[a-zA-Z0-9.-]+(?:\.[a-zA-Z]{2,})+(?:\/.*)?$/.test(e))return{isValid:!1,error:"Invalid URL format - must be HTTPS"};const a=e.match(/^https:\/\/([a-zA-Z0-9.-]+)/);if(!a)return{isValid:!1,error:"Could not extract hostname from URL"};const r=a[1].toLowerCase();return r==="localhost"||r.startsWith("127.")||r.startsWith("192.168.")||r.startsWith("10.")||r.match(/^172\.(1[6-9]|2[0-9]|3[01])\./)?{isValid:!1,error:"Private/internal URLs are not allowed"}:["bit.ly","tinyurl.com","goo.gl","ow.ly","pastebin.com","hastebin.com"].some(c=>r.includes(c))?{isValid:!1,error:"Potentially unsafe domain blocked"}:/^\d+\.\d+\.\d+\.\d+$/.test(r)?{isValid:!1,error:"Direct IP addresses are not allowed"}:!r.includes(".")||r.endsWith(".")?{isValid:!1,error:"Invalid domain format"}:{isValid:!0}}catch(t){return{isValid:!1,error:`Invalid URL format: ${t instanceof Error?t.message:"Unknown error"}`}}}const U=new Set;function V(e){return f(this,null,function*(){return re.includes(e)?!0:U.has(e)})}let p=null;const q=new Map,ne=100,se=3600*1e3,_=[];function ie(e){const t=Date.now(),a=q.get(e);return!a||t>a.resetTime?(q.set(e,{count:1,resetTime:t+se}),!1):a.count>=ne?!0:(a.count++,!1)}function H(e,t){return f(this,null,function*(){const a=b(e);return a?ie(a)?(figma.ui.postMessage({type:"log",level:"warning",message:`Rate limit exceeded for domain ${a}. Too many requests in the last hour.`}),!1):(p&&(clearTimeout(p.timeoutId),p.resolve(!1)),new Promise(r=>{figma.ui.postMessage({type:"request-domain-approval",url:e,domain:a,purpose:`${t} (WILDCARD ACCESS ENABLED - Extra caution advised)`});const i=setTimeout(()=>{p&&p.domain===a&&(p=null,_.push({domain:a,timestamp:Date.now(),approved:!1}),r(!1))},3e4);p={domain:a,resolve:c=>{_.push({domain:a,timestamp:Date.now(),approved:c}),r(c)},timeoutId:i}})):!1})}function oe(e,t){return f(this,null,function*(){try{if(!ee(t))return n("\u{1F6A8} SECURITY: Invalid or unsafe image URL","error"),!1;const a=t,r=F(a);if(!r.isValid)return n(`Invalid image URL: ${r.error}`,"error"),!1;const i=b(a);if(!i)return n("Unable to extract domain from URL","error"),!1;if(!(yield V(i))&&(n(`Domain ${i} not approved. Requesting approval...`,"warning"),!(yield H(t,"Image fetching"))))return n(`Domain ${i} was not approved by user`,"error"),!1;if(!A.isAllowed(a))return n("\u{1F6AB} Rate limit exceeded for this domain","warning"),!1;const s=yield fetch(a,{method:"GET",headers:{"User-Agent":"FigmaPlugin-Struct/1.0"}});if(!s)return n("Failed to fetch image: No response received","error"),!1;if(!s.ok)return n(`Failed to fetch image: HTTP ${s.status}`,"error"),!1;const g=s.headers&&s.headers.get&&s.headers.get("content-type")||"";if(g&&!g.startsWith("image/"))return n(`Invalid content type: ${g}`,"error"),!1;const l=s.headers&&s.headers.get?s.headers.get("content-length"):null;if(l&&parseInt(l)>10*1024*1024)return n("Image file too large (max 10MB)","error"),!1;let o;try{o=yield s.arrayBuffer()}catch(y){return n(`Failed to read image data: ${y.message}`,"error"),!1}if(!o||o.byteLength===0)return n("Received empty image data","error"),!1;const u=new Uint8Array(o);let m;try{m=figma.createImage(u)}catch(y){return n(`Failed to create image: ${y.message}`,"error"),!1}if(!m||!m.hash)return n("Failed to create valid image object","error"),!1;if("fills"in e){const y=[{type:"IMAGE",scaleMode:"FILL",imageHash:m.hash}];return e.fills=y,n(`Successfully applied image from ${i}`,"info"),!0}else n(`Layer "${e.name}" does not support image fills`,"warning");return!1}catch(a){const r=a.message;if(a.rateLimitError){const i=a.retryAfter;n(i?`\u{1F6AB} Rate limit exceeded. Please wait ${i} seconds before trying again.`:`\u{1F6AB} Rate limit exceeded: ${r}`,"warning")}else n(`Error fetching image: ${r}`,"error");return!1}})}function ce(e,t,a){try{if(e.variantProperties&&e.variantProperties[t]!==void 0){const r=x(a);if(r!==void 0)return e.setProperties({[t]:r}),n(`\u{1F512} Applied sanitized variant property: ${t} = ${r}`,"info"),!0}return!1}catch(r){return n("Failed to apply variant property","error"),!1}}function le(e,t){return e.map(a=>a.type==="text"?a.value:a.type==="key"&&T(t,a.value)||"").join("")}function ge(e,t,a){const r=a[e.jsonKey];return r?le(r.parts,t):T(t,e.jsonKey)}function n(e,t="info"){figma.ui.postMessage({type:"log",message:e,level:t})}function fe(r,i){return f(this,arguments,function*(e,t,a={}){const c=figma.currentPage.selection;if(c.length===0){n("No layers selected. Please select one or more component instances, groups, or frames.","warning");return}const s=te(c);if(s.length===0){n("No component instances found in selection. Please select component instances or containers with component instances.","warning");return}let g=0;const l=s.length;n(`Found ${s.length} component instances in selection. Starting to apply data...`,"info");for(let o=0;o<l;o++){const u=s[o],m=o%e.length,k=e[m];for(const h of t){const d=ge(h,k,a);if(d==null){n(`Missing value for key "${h.jsonKey}" in data item ${o+1}`,"warning");continue}const v=D(u,h.layerName);if(!v){n(`Layer "${h.layerName}" not found in instance "${u.name}"`,"warning");continue}if(v.type==="TEXT")ae(v,String(d)),n(`Applied text "${d}" to layer "${h.layerName}" in "${u.name}"`,"info");else if(typeof d=="string"&&(d.startsWith("http://")||d.startsWith("https://")))(yield oe(v,d))?n(`Applied image from URL to layer "${h.layerName}" in "${u.name}"`,"info"):n(`Failed to apply image from URL "${d}" to layer "${h.layerName}" in "${u.name}"`,"error");else if(v.type==="INSTANCE"&&typeof d=="string"){const S=v,N=Object.keys(S.variantProperties||{});if(N.length>0){const w=N.find(C=>C.toLowerCase()===h.layerName.toLowerCase()||h.layerName.toLowerCase().includes(C.toLowerCase()));w?ce(S,w,d)?n(`Applied variant property "${w}" = "${d}" in "${u.name}"`,"info"):n(`Failed to apply variant property "${w}" = "${d}" in "${u.name}"`,"error"):n(`No matching variant property found for "${h.layerName}" in "${u.name}"`,"warning")}}}g++}if(s.length>e.length){const o=Math.ceil(s.length/e.length);n(`\u{1F4C4} Data cycling: Used ${e.length} data items across ${s.length} instances (${o} cycles)`,"info")}else e.length>s.length?n(`\u{1F4C4} Data usage: Used ${s.length} of ${e.length} available data items`,"info"):n(`\u{1F4C4} Perfect match: ${s.length} instances with ${e.length} data items`,"info");n(`\u2705 Completed! Processed ${g} component instances across ${c.length} selected containers.`,"info")})}figma.showUI(__html__,{width:720,height:800,themeColors:!0});function ue(e){return f(this,null,function*(){try{const a=((yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[]).filter(i=>i.name!==e.name);a.unshift(e);const r=a.slice(0,20);yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",r),figma.ui.postMessage({type:"config-saved",data:r,message:`Configuration "${e.name}" saved successfully`})}catch(t){figma.ui.postMessage({type:"storage-error",message:"Failed to save configuration"})}})}function R(){return f(this,null,function*(){try{const e=(yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[],t=Y(e),{cleanedConfigurations:a,migrationSummary:r}=t;r.migratedConfigs>0&&(yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",a),figma.ui.postMessage({type:"log",message:`Security migration: Cleaned ${r.migratedConfigs} configurations by removing API credentials`,level:"info"})),figma.ui.postMessage({type:"configs-loaded",data:a})}catch(e){figma.ui.postMessage({type:"storage-error",message:`Failed to load configurations: ${e instanceof Error?e.message:"Unknown error"}`})}})}function de(e){return f(this,null,function*(){try{const a=((yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[]).filter(r=>r.name!==e);yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",a),figma.ui.postMessage({type:"config-deleted",data:a,message:`Configuration "${e}" deleted`})}catch(t){figma.ui.postMessage({type:"storage-error",message:"Failed to delete configuration"})}})}function pe(){return f(this,null,function*(){try{yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",[]),figma.ui.postMessage({type:"configs-cleared",data:[],message:"All configurations cleared"})}catch(e){figma.ui.postMessage({type:"storage-error",message:"Failed to clear configurations"})}})}function W(e){U.add(e)}function me(e){return f(this,null,function*(){try{const{url:t,method:a="GET",headers:r={},requestId:i}=e,c=F(t);if(!c.isValid){figma.ui.postMessage({type:"api-fetch-error",requestId:i,error:c.error});return}const s=b(t);if(!s){figma.ui.postMessage({type:"api-fetch-error",requestId:i,error:"Unable to extract domain from URL"});return}if(!(yield V(s))&&(n(`Domain ${s} not approved. Requesting approval...`,"warning"),!(yield H(t,"API data fetching")))){figma.ui.postMessage({type:"api-fetch-error",requestId:i,error:`Domain ${s} was not approved by user`});return}const l=Object.assign({"User-Agent":"FigmaPlugin-Struct/1.0"},r);if(typeof fetch=="undefined")throw new Error("Fetch API is not available in this context");const o=yield fetch(t,{method:a,headers:l});if(!o)throw new Error("Response object is undefined");if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const u=o.headers&&o.headers.get&&o.headers.get("content-type")||"";let m;if(u.includes("application/json"))m=yield o.json();else{const y=yield o.text();try{m=JSON.parse(y)}catch(k){m=y}}figma.ui.postMessage({type:"api-fetch-success",requestId:i,data:m,contentType:u}),n(`Successfully fetched data from ${s}`,"info")}catch(t){const a=t instanceof Error?t.message:"Unknown error";figma.ui.postMessage({type:"api-fetch-error",requestId:e.requestId,error:a}),n(`API fetch failed: ${a}`,"error")}})}function ye(e){return f(this,null,function*(){try{const{key:t,value:a}=e;if(!t)throw new Error("Storage key is required");yield figma.clientStorage.setAsync(t,a),figma.ui.postMessage({type:"storage-save-response",key:t,success:!0}),n(`Secure storage save completed for key: ${t}`,"info")}catch(t){const a=t instanceof Error?t.message:"Storage save failed";figma.ui.postMessage({type:"storage-save-response",key:e.key,success:!1,error:a}),n(`Secure storage save failed: ${a}`,"error")}})}function he(e){return f(this,null,function*(){try{const{key:t}=e;if(!t)throw new Error("Storage key is required");const a=yield figma.clientStorage.getAsync(t);figma.ui.postMessage({type:"storage-load-response",key:t,success:!0,value:a}),n(`Secure storage load completed for key: ${t}`,"info")}catch(t){const a=t instanceof Error?t.message:"Storage load failed";figma.ui.postMessage({type:"storage-load-response",key:e.key,success:!1,error:a,value:null}),n(`Secure storage load failed: ${a}`,"error")}})}figma.ui.onmessage=e=>f(null,null,function*(){switch(e.type){case"apply-data":const{jsonData:t,mappings:a,valueBuilders:r}=e;yield fe(t,a,r||{});break;case"save-config":yield ue(e.data);break;case"load-configs":yield R();break;case"delete-config":yield de(e.configName);break;case"clear-configs":yield pe();break;case"approve-domain":W(e.domain);break;case"domain-approval-response":p&&p.domain===e.domain&&(clearTimeout(p.timeoutId),e.approved?(W(e.domain),p.resolve(!0)):p.resolve(!1),p=null);break;case"fetch-api-data":yield me(e);break;case"storage-save-request":yield ye(e);break;case"storage-load-request":yield he(e);break;case"close":figma.closePlugin();break;default:break}}),figma.on("selectionchange",()=>{figma.ui.postMessage({type:"selection-changed",selectionCount:figma.currentPage.selection.length})}),f(null,null,function*(){try{yield R(),n("\u{1F4CA} Storage initialized with basic security","info")}catch(e){n(`\u26A0\uFE0F Storage initialization failed: ${e instanceof Error?e.message:"Unknown error"}`,"warning"),yield R()}});try{figma.ui.postMessage({type:"selection-changed",selectionCount:figma.currentPage.selection.length})}catch(e){figma.ui.postMessage({type:"selection-changed",selectionCount:0})}
