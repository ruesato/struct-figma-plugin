"use strict";var K=Object.defineProperty,B=Object.defineProperties;var j=Object.getOwnPropertyDescriptors;var E=Object.getOwnPropertySymbols;var J=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var x=(e,r,t)=>r in e?K(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,b=(e,r)=>{for(var t in r||(r={}))J.call(r,t)&&x(e,t,r[t]);if(E)for(var t of E(r))Z.call(r,t)&&x(e,t,r[t]);return e},N=(e,r)=>B(e,j(r));var u=(e,r,t)=>new Promise((a,s)=>{var o=g=>{try{l(t.next(g))}catch(c){s(c)}},i=g=>{try{l(t.throw(g))}catch(c){s(c)}},l=g=>g.done?a(g.value):Promise.resolve(g.value).then(o,i);l((t=t.apply(e,r)).next())});const G=[/authorization/i,/auth/i,/token/i,/key/i,/secret/i,/bearer/i,/api[_-]?key/i,/x-api[_-]?key/i,/access[_-]?token/i,/refresh[_-]?token/i,/session[_-]?token/i,/csrf[_-]?token/i,/jwt/i,/oauth/i,/credential/i,/password/i,/passwd/i,/pwd/i];function k(e){return G.some(r=>r.test(e))}function X(e){const r={};for(const[t,a]of Object.entries(e||{}))k(t)||(r[t]=a);return r}function Q(e){return N(b({},e),{apiKey:"",headers:X(e.headers)})}function Y(e){const{apiConfig:r}=e;return!!(r.apiKey&&r.apiKey.trim()!==""||Object.keys(r.headers||{}).some(a=>k(a)))}function ee(e){return N(b({},e),{apiConfig:Q(e.apiConfig)})}function te(e){const r=[];let t=0,a=0,s=0;for(const o of e)if(Y(o)){o.apiConfig.apiKey&&o.apiConfig.apiKey.trim()!==""&&a++;const i=Object.keys(o.apiConfig.headers||{}).filter(l=>k(l));s+=i.length,t++,r.push(ee(o))}else r.push(o);return{cleanedConfigurations:r,migrationSummary:{totalConfigs:e.length,migratedConfigs:t,removedApiKeys:a,removedHeaders:s}}}function T(e){if(!e||typeof e!="string")return"";const r=e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),t=5e4;return r.length>t?r.substring(0,t):r}function re(e){if(!e||typeof e!="string")return!1;try{const r=/^https:\/\/([a-zA-Z0-9.-]+)(?::\d+)?(?:\/.*)?$/,t=e.match(r);if(!t)return!1;const a=t[1].toLowerCase();return!(a==="localhost"||a.startsWith("127.")||a.startsWith("192.168.")||a.startsWith("10.")||a.match(/^172\.(1[6-9]|2[0-9]|3[01])\./)||/^\d+\.\d+\.\d+\.\d+$/.test(a))}catch(r){return!1}}function ae(e){return!e||typeof e!="string"?!1:!!(/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(e)||/^rgba?\(\s*\d+\s*,\s*\d+\s*,\s*\d+/i.test(e)||/^hsla?\(\s*\d+/i.test(e))}function ne(e,r){try{if(!("fills"in e))return n(`Layer "${e.name}" does not support fills`,"warning"),!1;const t=figma.util.solidPaint(r);return e.fills=[t],n(`Applied fill color "${r}" to layer "${e.name}"`,"info"),!0}catch(t){return n(`Invalid color value "${r}" for layer "${e.name}"`,"warning"),!1}}function se(e,r){try{if(!("strokes"in e))return!1;const t=e;if(!t.strokes||t.strokes.length===0)return!1;const a=figma.util.solidPaint(r);return t.strokes=[a],n(`Applied stroke color "${r}" to layer "${e.name}"`,"info"),!0}catch(t){return n(`Invalid stroke color "${r}" for layer "${e.name}"`,"warning"),!1}}class C{static isAllowed(r){const t=Date.now(),a=t-this.WINDOW_MS;this.requestHistory=this.requestHistory.filter(i=>i.timestamp>a);const s=this.extractDomain(r);return this.requestHistory.filter(i=>this.extractDomain(i.url)===s).length>=this.MAX_REQUESTS?!1:(this.requestHistory.push({url:r,timestamp:t}),!0)}static extractDomain(r){try{const t=r.match(/^https?:\/\/([a-zA-Z0-9.-]+)/);if(t&&t[1]){let a=t[1].toLowerCase();return a.includes("..")||a.startsWith(".")||a.endsWith(".")?"invalid":a}return"unknown"}catch(t){return"unknown"}}}C.requestHistory=[],C.MAX_REQUESTS=25,C.WINDOW_MS=6e4;function D(e,r){return r.split(".").reduce((a,s)=>{if(a==null)return;const o=s.match(/^(.+)\[(\d*)\]$/);if(o){const[,i,l]=o,g=a[i];return Array.isArray(g)?l===""?g[0]:g[parseInt(l)]:void 0}return a[s]},e)}function L(e,r){if(e.name===r)return e;if("children"in e)for(const t of e.children){const a=L(t,r);if(a)return a}return null}function F(e){const r=[];if((e.type==="INSTANCE"||e.type==="FRAME"||e.type==="GROUP"||e.type==="COMPONENT")&&r.push(e),"children"in e)for(const t of e.children)r.push(...F(t));return r}function U(e){const r=[];if(e.type==="INSTANCE"&&r.push(e),"children"in e)for(const t of e.children)r.push(...U(t));return r}function ie(e){const r=[];for(const t of e)if(t.type==="INSTANCE"||t.type==="FRAME"||t.type==="GROUP"||t.type==="COMPONENT")r.push(t);else{const a=F(t);r.push(...a)}return r}function be(e){const r=[];for(const t of e)if(t.type==="INSTANCE")r.push(t);else{const a=U(t);r.push(...a)}return r}function oe(e,r){try{const t=T(String(r));figma.loadFontAsync(e.fontName).then(()=>{e.characters=t,n(`\u{1F512} Applied sanitized text content (${t.length} chars)`,"info")})}catch(t){n("Failed to apply text content","error")}}const ce=["jsonplaceholder.typicode.com","api.github.com","httpbin.org","images.unsplash.com","via.placeholder.com","picsum.photos","loremflickr.com","dummyimage.com"];function h(e){try{const r=e.match(/^https?:\/\/([a-zA-Z0-9.-]+)/);return r?r[1]:null}catch(r){return null}}function w(e,r){let t=e.replace(/https?:\/\/[^\s]+/g,a=>{const s=h(a);return s?`[${s}]`:"[redacted-url]"});if(t=t.replace(/[?&](?:key|token|apikey|api_key|access_token)=[^&\s]+/gi,"[api-key-redacted]"),t=t.replace(/\/[a-zA-Z0-9._/-]+\.(js|ts|json|html)/g,"[file-path]"),r){const a=h(r);a&&(t=t.replace(/for [^\s:]+:?/g,`for ${a}:`))}return t}function _(e){try{if(!/^https:\/\/[a-zA-Z0-9.-]+(?:\.[a-zA-Z]{2,})+(?:\/.*)?$/.test(e))return{isValid:!1,error:"Invalid URL format - must be HTTPS"};const t=e.match(/^https:\/\/([a-zA-Z0-9.-]+)/);if(!t)return{isValid:!1,error:"Could not extract hostname from URL"};const a=t[1].toLowerCase();return a==="localhost"||a.startsWith("127.")||a.startsWith("192.168.")||a.startsWith("10.")||a.match(/^172\.(1[6-9]|2[0-9]|3[01])\./)?{isValid:!1,error:"Private/internal URLs are not allowed"}:["bit.ly","tinyurl.com","goo.gl","ow.ly","pastebin.com","hastebin.com"].some(o=>a.includes(o))?{isValid:!1,error:"Potentially unsafe domain blocked"}:/^\d+\.\d+\.\d+\.\d+$/.test(a)?{isValid:!1,error:"Direct IP addresses are not allowed"}:!a.includes(".")||a.endsWith(".")?{isValid:!1,error:"Invalid domain format"}:{isValid:!0}}catch(r){return{isValid:!1,error:`Invalid URL format: ${r instanceof Error?r.message:"Unknown error"}`}}}const V=new Set;function q(e){return u(this,null,function*(){return ce.includes(e)?!0:V.has(e)})}let d=null;const z=new Map,le=250,fe=3600*1e3,O=[];function ge(e){const r=Date.now(),t=z.get(e);return!t||r>t.resetTime?(z.set(e,{count:1,resetTime:r+fe}),!1):t.count>=le?!0:(t.count++,!1)}function W(e,r){return u(this,null,function*(){const t=h(e);return t?ge(t)?(figma.ui.postMessage({type:"log",level:"warning",message:`Rate limit exceeded for domain ${t}. Too many requests in the last hour.`}),!1):(d&&(clearTimeout(d.timeoutId),d.resolve(!1)),new Promise(a=>{figma.ui.postMessage({type:"request-domain-approval",url:e,domain:t,purpose:`${r} (WILDCARD ACCESS ENABLED - Extra caution advised)`});const s=setTimeout(()=>{d&&d.domain===t&&(d=null,O.push({domain:t,timestamp:Date.now(),approved:!1}),a(!1))},3e4);d={domain:t,resolve:o=>{O.push({domain:t,timestamp:Date.now(),approved:o}),a(o)},timeoutId:s}})):!1})}function ue(e,r){return u(this,null,function*(){try{if(!re(r))return n("\u{1F6A8} SECURITY: Invalid or unsafe image URL","error"),!1;const t=r,a=_(t);if(!a.isValid)return n(`Invalid image URL: ${a.error}`,"error"),!1;const s=h(t);if(!s)return n("Unable to extract domain from URL","error"),!1;if(!(yield q(s))&&(n(`Domain ${s} not approved. Requesting approval...`,"warning"),!(yield W(r,"Image fetching"))))return n(`Domain ${s} was not approved by user`,"error"),!1;if(!C.isAllowed(t))return n("\u{1F6AB} Rate limit exceeded for this domain","warning"),!1;n(`\u{1F517} Fetching image from: ${t}`,"info");let i;try{i=yield figma.createImageAsync(t)}catch(l){return n(`Failed to create image from URL: ${w(l.message)}`,"error"),!1}if(!i||!i.hash)return n("Failed to create valid image object","error"),!1;if("fills"in e){const l=[{type:"IMAGE",scaleMode:"FILL",imageHash:i.hash}];return e.fills=l,n(`Successfully applied image from ${s}`,"info"),!0}else n(`Layer "${e.name}" does not support image fills`,"warning");return!1}catch(t){const a=t.message,s=h(r);if(n(`\u{1F6A8} Image fetch error for ${s}:`,"error"),n(`Error details: ${w(a,r)}`,"error"),a.includes("CORS"))n("\u274C CORS Error: Using figma.createImageAsync should avoid this","error"),n(`\u{1F4A1} Domain ${s} should be accessible`,"info");else if(t.rateLimitError){const o=t.retryAfter;n(o?`\u{1F6AB} Rate limit exceeded. Please wait ${o} seconds before trying again.`:`\u{1F6AB} Rate limit exceeded for ${s}`,"warning")}else a.includes("fetch")?n(`\u{1F310} Network error accessing ${s}`,"error"):n(`\u2753 Unknown error accessing ${s}`,"error");return!1}})}function de(e,r,t){try{if(e.variantProperties&&e.variantProperties[r]!==void 0){const a=T(t);if(a!==void 0)return e.setProperties({[r]:a}),n(`\u{1F512} Applied sanitized variant property: ${r} = ${a}`,"info"),!0}return!1}catch(a){return n("Failed to apply variant property","error"),!1}}function pe(e,r){return e.map(t=>t.type==="text"?t.value:t.type==="key"&&D(r,t.value)||"").join("")}function me(e,r,t){const a=t[e.jsonKey];return a?pe(a.parts,r):D(r,e.jsonKey)}function n(e,r="info"){figma.ui.postMessage({type:"log",message:e,level:r})}function ye(a,s){return u(this,arguments,function*(e,r,t={}){const o=figma.currentPage.selection;if(o.length===0){n("No layers selected. Please select one or more frames, groups, component instances, or other containers.","warning");return}const i=ie(o);if(i.length===0){n("No valid containers found in selection. Please select frames, groups, component instances, or other container nodes.","warning");return}let l=0;const g=i.length;n(`Found ${i.length} containers in selection. Starting to apply data...`,"info");for(let c=0;c<g;c++){const p=i[c],v=c%e.length,R=e[v];for(const m of r){const f=me(m,R,t);if(f==null){n(`Missing value for key "${m.jsonKey}" in data item ${c+1}`,"warning");continue}const y=L(p,m.layerName);if(!y){n(`Layer "${m.layerName}" not found in container "${p.name}"`,"warning");continue}if(typeof f=="string"&&(f.startsWith("http://")||f.startsWith("https://")))(yield ue(y,f))?n(`Applied image from URL to layer "${m.layerName}" in "${p.name}"`,"info"):n(`Failed to apply image from ${h(f)||"URL"} to layer "${m.layerName}" in "${p.name}"`,"error");else if(typeof f=="string"&&ae(f))ne(y,f),se(y,f);else if(y.type==="TEXT")oe(y,String(f)),n(`Applied text "${f}" to layer "${m.layerName}" in "${p.name}"`,"info");else if(y.type==="INSTANCE"&&typeof f=="string"){const $=y,P=Object.keys($.variantProperties||{});if(P.length>0){const S=P.find(M=>M.toLowerCase()===m.layerName.toLowerCase()||m.layerName.toLowerCase().includes(M.toLowerCase()));S?de($,S,f)?n(`Applied variant property "${S}" = "${f}" in "${p.name}"`,"info"):n(`Failed to apply variant property "${S}" = "${f}" in "${p.name}"`,"error"):n(`No matching variant property found for "${m.layerName}" in "${p.name}"`,"warning")}}}l++}if(i.length>e.length){const c=Math.ceil(i.length/e.length);n(`\u{1F4C4} Data cycling: Used ${e.length} data items across ${i.length} containers (${c} cycles)`,"info")}else e.length>i.length?n(`\u{1F4C4} Data usage: Used ${i.length} of ${e.length} available data items`,"info"):n(`\u{1F4C4} Perfect match: ${i.length} containers with ${e.length} data items`,"info");n(`\u2705 Completed! Processed ${l} containers (frames, groups, instances) across ${o.length} selected items.`,"info")})}function he(a,s){return u(this,arguments,function*(e,r,t={}){return ye(e,r,t)})}figma.showUI(__html__,{width:720,height:800,themeColors:!0});function ve(e){return u(this,null,function*(){try{const t=((yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[]).filter(s=>s.name!==e.name);t.unshift(e);const a=t.slice(0,20);yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",a),figma.ui.postMessage({type:"config-saved",data:a,message:`Configuration "${e.name}" saved successfully`})}catch(r){figma.ui.postMessage({type:"storage-error",message:"Failed to save configuration"})}})}function I(){return u(this,null,function*(){try{const e=(yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[],r=te(e),{cleanedConfigurations:t,migrationSummary:a}=r;a.migratedConfigs>0&&(yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",t),figma.ui.postMessage({type:"log",message:`Security migration: Cleaned ${a.migratedConfigs} configurations by removing API credentials`,level:"info"})),figma.ui.postMessage({type:"configs-loaded",data:t})}catch(e){figma.ui.postMessage({type:"storage-error",message:`Failed to load configurations: ${e instanceof Error?e.message:"Unknown error"}`})}})}function we(e){return u(this,null,function*(){try{const t=((yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[]).filter(a=>a.name!==e);yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",t),figma.ui.postMessage({type:"config-deleted",data:t,message:`Configuration "${e}" deleted`})}catch(r){figma.ui.postMessage({type:"storage-error",message:"Failed to delete configuration"})}})}function Ae(){return u(this,null,function*(){try{yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",[]),figma.ui.postMessage({type:"configs-cleared",data:[],message:"All configurations cleared"})}catch(e){figma.ui.postMessage({type:"storage-error",message:"Failed to clear configurations"})}})}function H(e){V.add(e)}function Se(e){return u(this,null,function*(){try{const{url:r,method:t="GET",headers:a={},requestId:s}=e,o=_(r);if(!o.isValid){figma.ui.postMessage({type:"api-fetch-error",requestId:s,error:o.error});return}const i=h(r);if(!i){figma.ui.postMessage({type:"api-fetch-error",requestId:s,error:"Unable to extract domain from URL"});return}if(!(yield q(i))&&(n(`Domain ${i} not approved. Requesting approval...`,"warning"),!(yield W(r,"API data fetching")))){figma.ui.postMessage({type:"api-fetch-error",requestId:s,error:`Domain ${i} was not approved by user`});return}const g=Object.assign({"User-Agent":"FigmaPlugin-Struct/1.0"},a);if(typeof fetch=="undefined")throw new Error("Fetch API is not available in this context");const c=yield fetch(r,{method:t,headers:g});if(!c)throw new Error("Response object is undefined");if(!c.ok)throw new Error(`HTTP ${c.status}: ${c.statusText}`);const p=c.headers&&c.headers.get&&c.headers.get("content-type")||"";let v;if(p.includes("application/json"))v=yield c.json();else{const A=yield c.text();try{v=JSON.parse(A)}catch(R){v=A}}figma.ui.postMessage({type:"api-fetch-success",requestId:s,data:v,contentType:p}),n(`Successfully fetched data from ${i}`,"info")}catch(r){const t=r instanceof Error?r.message:"Unknown error";figma.ui.postMessage({type:"api-fetch-error",requestId:e.requestId,error:t}),n(`API fetch failed: ${w(t)}`,"error")}})}function Ce(e){return u(this,null,function*(){try{const{key:r,value:t}=e;if(!r)throw new Error("Storage key is required");yield figma.clientStorage.setAsync(r,t),figma.ui.postMessage({type:"storage-save-response",key:r,success:!0}),n(`Secure storage save completed for key: ${r}`,"info")}catch(r){const t=r instanceof Error?r.message:"Storage save failed";figma.ui.postMessage({type:"storage-save-response",key:e.key,success:!1,error:t}),n(`Secure storage save failed: ${w(t)}`,"error")}})}function $e(e){return u(this,null,function*(){try{const{key:r}=e;if(!r)throw new Error("Storage key is required");const t=yield figma.clientStorage.getAsync(r);figma.ui.postMessage({type:"storage-load-response",key:r,success:!0,value:t}),n(`Secure storage load completed for key: ${r}`,"info")}catch(r){const t=r instanceof Error?r.message:"Storage load failed";figma.ui.postMessage({type:"storage-load-response",key:e.key,success:!1,error:t,value:null}),n(`Secure storage load failed: ${w(t)}`,"error")}})}figma.ui.onmessage=e=>u(null,null,function*(){switch(e.type){case"apply-data":const{jsonData:r,mappings:t,valueBuilders:a}=e;yield he(r,t,a||{});break;case"save-config":yield ve(e.data);break;case"load-configs":yield I();break;case"delete-config":yield we(e.configName);break;case"clear-configs":yield Ae();break;case"approve-domain":H(e.domain);break;case"domain-approval-response":d&&d.domain===e.domain&&(clearTimeout(d.timeoutId),e.approved?(H(e.domain),d.resolve(!0)):d.resolve(!1),d=null);break;case"fetch-api-data":yield Se(e);break;case"storage-save-request":yield Ce(e);break;case"storage-load-request":yield $e(e);break;case"close":figma.closePlugin();break;default:break}}),figma.on("selectionchange",()=>{figma.ui.postMessage({type:"selection-changed",selectionCount:figma.currentPage.selection.length})}),u(null,null,function*(){try{yield I(),n("\u{1F4CA} Storage initialized with basic security","info")}catch(e){n(`\u26A0\uFE0F Storage initialization failed: ${e instanceof Error?w(e.message):"Unknown error"}`,"warning"),yield I()}});try{figma.ui.postMessage({type:"selection-changed",selectionCount:figma.currentPage.selection.length})}catch(e){figma.ui.postMessage({type:"selection-changed",selectionCount:0})}
