"use strict";var _=Object.defineProperty,z=Object.defineProperties;var H=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var W=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;var P=(e,t,r)=>t in e?_(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,C=(e,t)=>{for(var r in t||(t={}))W.call(t,r)&&P(e,r,t[r]);if(I)for(var r of I(t))B.call(t,r)&&P(e,r,t[r]);return e},M=(e,t)=>z(e,H(t));var d=(e,t,r)=>new Promise((a,s)=>{var i=c=>{try{f(r.next(c))}catch(l){s(l)}},o=c=>{try{f(r.throw(c))}catch(l){s(l)}},f=c=>c.done?a(c.value):Promise.resolve(c.value).then(i,o);f((r=r.apply(e,t)).next())});const K=[/authorization/i,/auth/i,/token/i,/key/i,/secret/i,/bearer/i,/api[_-]?key/i,/x-api[_-]?key/i,/access[_-]?token/i,/refresh[_-]?token/i,/session[_-]?token/i,/csrf[_-]?token/i,/jwt/i,/oauth/i,/credential/i,/password/i,/passwd/i,/pwd/i];function b(e){return K.some(t=>t.test(e))}function j(e){const t={};for(const[r,a]of Object.entries(e||{}))b(r)||(t[r]=a);return t}function O(e){return M(C({},e),{apiKey:"",headers:j(e.headers)})}function J(e){const{apiConfig:t}=e;return!!(t.apiKey&&t.apiKey.trim()!==""||Object.keys(t.headers||{}).some(a=>b(a)))}function Z(e){return M(C({},e),{apiConfig:O(e.apiConfig)})}function X(e){const t=[];let r=0,a=0,s=0;for(const i of e)if(J(i)){i.apiConfig.apiKey&&i.apiConfig.apiKey.trim()!==""&&a++;const o=Object.keys(i.apiConfig.headers||{}).filter(f=>b(f));s+=o.length,r++,t.push(Z(i))}else t.push(i);return{cleanedConfigurations:t,migrationSummary:{totalConfigs:e.length,migratedConfigs:r,removedApiKeys:a,removedHeaders:s}}}function x(e){if(!e||typeof e!="string")return"";const t=e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),r=5e4;return t.length>r?t.substring(0,r):t}function G(e){if(!e||typeof e!="string")return!1;try{const t=/^https:\/\/([a-zA-Z0-9.-]+)(?::\d+)?(?:\/.*)?$/,r=e.match(t);if(!r)return!1;const a=r[1].toLowerCase();return!(a==="localhost"||a.startsWith("127.")||a.startsWith("192.168.")||a.startsWith("10.")||a.match(/^172\.(1[6-9]|2[0-9]|3[01])\./)||/^\d+\.\d+\.\d+\.\d+$/.test(a))}catch(t){return!1}}class w{static isAllowed(t){const r=Date.now(),a=r-this.WINDOW_MS;this.requestHistory=this.requestHistory.filter(o=>o.timestamp>a);const s=this.extractDomain(t);return this.requestHistory.filter(o=>this.extractDomain(o.url)===s).length>=this.MAX_REQUESTS?!1:(this.requestHistory.push({url:t,timestamp:r}),!0)}static extractDomain(t){try{const r=t.match(/^https?:\/\/([a-zA-Z0-9.-]+)/);if(r&&r[1]){let a=r[1].toLowerCase();return a.includes("..")||a.startsWith(".")||a.endsWith(".")?"invalid":a}return"unknown"}catch(r){return"unknown"}}}w.requestHistory=[],w.MAX_REQUESTS=25,w.WINDOW_MS=6e4;function E(e,t){return t.split(".").reduce((a,s)=>{if(a==null)return;const i=s.match(/^(.+)\[(\d*)\]$/);if(i){const[,o,f]=i,c=a[o];return Array.isArray(c)?f===""?c[0]:c[parseInt(f)]:void 0}return a[s]},e)}function D(e,t){if(e.name===t)return e;if("children"in e)for(const r of e.children){const a=D(r,t);if(a)return a}return null}function Q(e,t){try{const r=x(String(t));figma.loadFontAsync(e.fontName).then(()=>{e.characters=r,n(`\u{1F512} Applied sanitized text content (${r.length} chars)`,"info")})}catch(r){n("Failed to apply text content","error")}}const Y=["jsonplaceholder.typicode.com","api.github.com","httpbin.org","images.unsplash.com","via.placeholder.com","picsum.photos","loremflickr.com","dummyimage.com"];function $(e){try{const t=e.match(/^https?:\/\/([a-zA-Z0-9.-]+)/);return t?t[1]:null}catch(t){return null}}function N(e){try{if(!/^https:\/\/[a-zA-Z0-9.-]+(?:\.[a-zA-Z]{2,})+(?:\/.*)?$/.test(e))return{isValid:!1,error:"Invalid URL format - must be HTTPS"};const r=e.match(/^https:\/\/([a-zA-Z0-9.-]+)/);if(!r)return{isValid:!1,error:"Could not extract hostname from URL"};const a=r[1].toLowerCase();return a==="localhost"||a.startsWith("127.")||a.startsWith("192.168.")||a.startsWith("10.")||a.match(/^172\.(1[6-9]|2[0-9]|3[01])\./)?{isValid:!1,error:"Private/internal URLs are not allowed"}:["bit.ly","tinyurl.com","goo.gl","ow.ly","pastebin.com","hastebin.com"].some(i=>a.includes(i))?{isValid:!1,error:"Potentially unsafe domain blocked"}:/^\d+\.\d+\.\d+\.\d+$/.test(a)?{isValid:!1,error:"Direct IP addresses are not allowed"}:!a.includes(".")||a.endsWith(".")?{isValid:!1,error:"Invalid domain format"}:{isValid:!0}}catch(t){return{isValid:!1,error:`Invalid URL format: ${t instanceof Error?t.message:"Unknown error"}`}}}const T=new Set;function L(e){return d(this,null,function*(){return Y.includes(e)?!0:T.has(e)})}let p=null;const F=new Map,ee=100,te=3600*1e3,U=[];function re(e){const t=Date.now(),r=F.get(e);return!r||t>r.resetTime?(F.set(e,{count:1,resetTime:t+te}),!1):r.count>=ee?!0:(r.count++,!1)}function V(e,t){return d(this,null,function*(){const r=$(e);return r?re(r)?(figma.ui.postMessage({type:"log",level:"warning",message:`Rate limit exceeded for domain ${r}. Too many requests in the last hour.`}),!1):(p&&(clearTimeout(p.timeoutId),p.resolve(!1)),new Promise(a=>{figma.ui.postMessage({type:"request-domain-approval",url:e,domain:r,purpose:`${t} (WILDCARD ACCESS ENABLED - Extra caution advised)`});const s=setTimeout(()=>{p&&p.domain===r&&(p=null,U.push({domain:r,timestamp:Date.now(),approved:!1}),a(!1))},3e4);p={domain:r,resolve:i=>{U.push({domain:r,timestamp:Date.now(),approved:i}),a(i)},timeoutId:s}})):!1})}function ae(e,t){return d(this,null,function*(){try{if(!G(t))return n("\u{1F6A8} SECURITY: Invalid or unsafe image URL","error"),!1;const r=t,a=N(r);if(!a.isValid)return n(`Invalid image URL: ${a.error}`,"error"),!1;const s=$(r);if(!s)return n("Unable to extract domain from URL","error"),!1;if(!(yield L(s))&&(n(`Domain ${s} not approved. Requesting approval...`,"warning"),!(yield V(t,"Image fetching"))))return n(`Domain ${s} was not approved by user`,"error"),!1;if(!w.isAllowed(r))return n("\u{1F6AB} Rate limit exceeded for this domain","warning"),!1;const o=yield fetch(r,{method:"GET",headers:{"User-Agent":"FigmaPlugin-Struct/1.0"}});if(!o)return n("Failed to fetch image: No response received","error"),!1;if(!o.ok)return n(`Failed to fetch image: HTTP ${o.status}`,"error"),!1;const f=o.headers&&o.headers.get&&o.headers.get("content-type")||"";if(f&&!f.startsWith("image/"))return n(`Invalid content type: ${f}`,"error"),!1;const c=o.headers&&o.headers.get?o.headers.get("content-length"):null;if(c&&parseInt(c)>10*1024*1024)return n("Image file too large (max 10MB)","error"),!1;let l;try{l=yield o.arrayBuffer()}catch(g){return n(`Failed to read image data: ${g.message}`,"error"),!1}if(!l||l.byteLength===0)return n("Received empty image data","error"),!1;const h=new Uint8Array(l);let m;try{m=figma.createImage(h)}catch(g){return n(`Failed to create image: ${g.message}`,"error"),!1}if(!m||!m.hash)return n("Failed to create valid image object","error"),!1;if("fills"in e){const g=[{type:"IMAGE",scaleMode:"FILL",imageHash:m.hash}];return e.fills=g,n(`Successfully applied image from ${s}`,"info"),!0}else n(`Layer "${e.name}" does not support image fills`,"warning");return!1}catch(r){const a=r.message;if(r.rateLimitError){const s=r.retryAfter;n(s?`\u{1F6AB} Rate limit exceeded. Please wait ${s} seconds before trying again.`:`\u{1F6AB} Rate limit exceeded: ${a}`,"warning")}else n(`Error fetching image: ${a}`,"error");return!1}})}function ne(e,t,r){try{if(e.variantProperties&&e.variantProperties[t]!==void 0){const a=x(r);if(a!==void 0)return e.setProperties({[t]:a}),n(`\u{1F512} Applied sanitized variant property: ${t} = ${a}`,"info"),!0}return!1}catch(a){return n("Failed to apply variant property","error"),!1}}function se(e,t){return e.map(r=>r.type==="text"?r.value:r.type==="key"&&E(t,r.value)||"").join("")}function ie(e,t,r){const a=r[e.jsonKey];return a?se(a.parts,t):E(t,e.jsonKey)}function n(e,t="info"){figma.ui.postMessage({type:"log",message:e,level:t})}function oe(a,s){return d(this,arguments,function*(e,t,r={}){const i=figma.currentPage.selection;if(i.length===0){n("No layers selected. Please select one or more component instances or layers.","warning");return}let o=0;const f=Math.min(i.length,e.length);n(`Starting to apply data to ${f} selected instances...`,"info");for(let c=0;c<f;c++){const l=i[c],m=e[c];n(`\u{1F512} Processing sanitized instance ${c+1}/${f}: ${l.name}`,"info");for(const g of t){const u=ie(g,m,r);if(u==null){n(`Missing value for key "${g.jsonKey}" in data item ${c+1}`,"warning");continue}const y=D(l,g.layerName);if(!y){n(`Layer "${g.layerName}" not found in ${l.name}`,"warning");continue}if(y.type==="TEXT")Q(y,String(u)),n(`Applied text "${u}" to layer "${g.layerName}"`,"info");else if(typeof u=="string"&&(u.startsWith("http://")||u.startsWith("https://")))(yield ae(y,u))?n(`Applied image from URL to layer "${g.layerName}"`,"info"):n(`Failed to apply image from URL "${u}" to layer "${g.layerName}"`,"error");else if(y.type==="INSTANCE"&&typeof u=="string"){const A=y,k=Object.keys(A.variantProperties||{});if(k.length>0){const v=k.find(S=>S.toLowerCase()===g.layerName.toLowerCase()||g.layerName.toLowerCase().includes(S.toLowerCase()));v?ne(A,v,u)?n(`Applied variant property "${v}" = "${u}"`,"info"):n(`Failed to apply variant property "${v}" = "${u}"`,"error"):n(`No matching variant property found for "${g.layerName}"`,"warning")}}}o++}e.length>i.length?n(`${e.length-i.length} JSON objects were ignored (more data than selected instances)`,"warning"):i.length>e.length&&n(`${i.length-e.length} selected instances were left unchanged (more instances than data)`,"info"),n(`\u2705 Completed! Processed ${o} instances.`,"info")})}figma.showUI(__html__,{width:720,height:800,themeColors:!0});function ce(e){return d(this,null,function*(){try{const r=((yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[]).filter(s=>s.name!==e.name);r.unshift(e);const a=r.slice(0,20);yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",a),figma.ui.postMessage({type:"config-saved",data:a,message:`Configuration "${e.name}" saved successfully`})}catch(t){figma.ui.postMessage({type:"storage-error",message:"Failed to save configuration"})}})}function R(){return d(this,null,function*(){try{const e=(yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[],t=X(e),{cleanedConfigurations:r,migrationSummary:a}=t;a.migratedConfigs>0&&(yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",r),figma.ui.postMessage({type:"log",message:`Security migration: Cleaned ${a.migratedConfigs} configurations by removing API credentials`,level:"info"})),figma.ui.postMessage({type:"configs-loaded",data:r})}catch(e){figma.ui.postMessage({type:"storage-error",message:`Failed to load configurations: ${e instanceof Error?e.message:"Unknown error"}`})}})}function le(e){return d(this,null,function*(){try{const r=((yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[]).filter(a=>a.name!==e);yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",r),figma.ui.postMessage({type:"config-deleted",data:r,message:`Configuration "${e}" deleted`})}catch(t){figma.ui.postMessage({type:"storage-error",message:"Failed to delete configuration"})}})}function ge(){return d(this,null,function*(){try{yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",[]),figma.ui.postMessage({type:"configs-cleared",data:[],message:"All configurations cleared"})}catch(e){figma.ui.postMessage({type:"storage-error",message:"Failed to clear configurations"})}})}function q(e){T.add(e)}function fe(e){return d(this,null,function*(){try{const{url:t,method:r="GET",headers:a={},requestId:s}=e,i=N(t);if(!i.isValid){figma.ui.postMessage({type:"api-fetch-error",requestId:s,error:i.error});return}const o=$(t);if(!o){figma.ui.postMessage({type:"api-fetch-error",requestId:s,error:"Unable to extract domain from URL"});return}if(!(yield L(o))&&(n(`Domain ${o} not approved. Requesting approval...`,"warning"),!(yield V(t,"API data fetching")))){figma.ui.postMessage({type:"api-fetch-error",requestId:s,error:`Domain ${o} was not approved by user`});return}const c=Object.assign({"User-Agent":"FigmaPlugin-Struct/1.0"},a);if(typeof fetch=="undefined")throw new Error("Fetch API is not available in this context");const l=yield fetch(t,{method:r,headers:c});if(!l)throw new Error("Response object is undefined");if(!l.ok)throw new Error(`HTTP ${l.status}: ${l.statusText}`);const h=l.headers&&l.headers.get&&l.headers.get("content-type")||"";let m;if(h.includes("application/json"))m=yield l.json();else{const g=yield l.text();try{m=JSON.parse(g)}catch(u){m=g}}figma.ui.postMessage({type:"api-fetch-success",requestId:s,data:m,contentType:h}),n(`Successfully fetched data from ${o}`,"info")}catch(t){const r=t instanceof Error?t.message:"Unknown error";figma.ui.postMessage({type:"api-fetch-error",requestId:e.requestId,error:r}),n(`API fetch failed: ${r}`,"error")}})}function ue(e){return d(this,null,function*(){try{const{key:t,value:r}=e;if(!t)throw new Error("Storage key is required");yield figma.clientStorage.setAsync(t,r),figma.ui.postMessage({type:"storage-save-response",key:t,success:!0}),n(`Secure storage save completed for key: ${t}`,"info")}catch(t){const r=t instanceof Error?t.message:"Storage save failed";figma.ui.postMessage({type:"storage-save-response",key:e.key,success:!1,error:r}),n(`Secure storage save failed: ${r}`,"error")}})}function de(e){return d(this,null,function*(){try{const{key:t}=e;if(!t)throw new Error("Storage key is required");const r=yield figma.clientStorage.getAsync(t);figma.ui.postMessage({type:"storage-load-response",key:t,success:!0,value:r}),n(`Secure storage load completed for key: ${t}`,"info")}catch(t){const r=t instanceof Error?t.message:"Storage load failed";figma.ui.postMessage({type:"storage-load-response",key:e.key,success:!1,error:r,value:null}),n(`Secure storage load failed: ${r}`,"error")}})}figma.ui.onmessage=e=>d(null,null,function*(){switch(e.type){case"apply-data":const{jsonData:t,mappings:r,valueBuilders:a}=e;yield oe(t,r,a||{});break;case"save-config":yield ce(e.data);break;case"load-configs":yield R();break;case"delete-config":yield le(e.configName);break;case"clear-configs":yield ge();break;case"approve-domain":q(e.domain);break;case"domain-approval-response":p&&p.domain===e.domain&&(clearTimeout(p.timeoutId),e.approved?(q(e.domain),p.resolve(!0)):p.resolve(!1),p=null);break;case"fetch-api-data":yield fe(e);break;case"storage-save-request":yield ue(e);break;case"storage-load-request":yield de(e);break;case"close":figma.closePlugin();break;default:break}}),figma.on("selectionchange",()=>{figma.ui.postMessage({type:"selection-changed",selectionCount:figma.currentPage.selection.length})}),d(null,null,function*(){try{yield R(),n("\u{1F4CA} Storage initialized with basic security","info")}catch(e){n(`\u26A0\uFE0F Storage initialization failed: ${e instanceof Error?e.message:"Unknown error"}`,"warning"),yield R()}});try{figma.ui.postMessage({type:"selection-changed",selectionCount:figma.currentPage.selection.length})}catch(e){figma.ui.postMessage({type:"selection-changed",selectionCount:0})}
