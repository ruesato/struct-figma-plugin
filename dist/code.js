"use strict";var B=Object.defineProperty,J=Object.defineProperties;var Z=Object.getOwnPropertyDescriptors;var E=Object.getOwnPropertySymbols;var G=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable;var T=(e,r,t)=>r in e?B(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,k=(e,r)=>{for(var t in r||(r={}))G.call(r,t)&&T(e,t,r[t]);if(E)for(var t of E(r))X.call(r,t)&&T(e,t,r[t]);return e},N=(e,r)=>J(e,Z(r));var u=(e,r,t)=>new Promise((a,s)=>{var o=g=>{try{f(t.next(g))}catch(c){s(c)}},i=g=>{try{f(t.throw(g))}catch(c){s(c)}},f=g=>g.done?a(g.value):Promise.resolve(g.value).then(o,i);f((t=t.apply(e,r)).next())});const Q=[/authorization/i,/auth/i,/token/i,/key/i,/secret/i,/bearer/i,/api[_-]?key/i,/x-api[_-]?key/i,/access[_-]?token/i,/refresh[_-]?token/i,/session[_-]?token/i,/csrf[_-]?token/i,/jwt/i,/oauth/i,/credential/i,/password/i,/passwd/i,/pwd/i];function I(e){return Q.some(r=>r.test(e))}function Y(e){const r={};for(const[t,a]of Object.entries(e||{}))I(t)||(r[t]=a);return r}function ee(e){return N(k({},e),{apiKey:"",headers:Y(e.headers)})}function te(e){const{apiConfig:r}=e;return!!(r.apiKey&&r.apiKey.trim()!==""||Object.keys(r.headers||{}).some(a=>I(a)))}function re(e){return N(k({},e),{apiConfig:ee(e.apiConfig)})}function ae(e){const r=[];let t=0,a=0,s=0;for(const o of e)if(te(o)){o.apiConfig.apiKey&&o.apiConfig.apiKey.trim()!==""&&a++;const i=Object.keys(o.apiConfig.headers||{}).filter(f=>I(f));s+=i.length,t++,r.push(re(o))}else r.push(o);return{cleanedConfigurations:r,migrationSummary:{totalConfigs:e.length,migratedConfigs:t,removedApiKeys:a,removedHeaders:s}}}function x(e){if(!e||typeof e!="string")return"";const r=e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),t=5e4;return r.length>t?r.substring(0,t):r}function ne(e){if(!e||typeof e!="string")return!1;try{const r=/^https:\/\/([a-zA-Z0-9.-]+)(?::\d+)?(?:\/.*)?$/,t=e.match(r);if(!t)return!1;const a=t[1].toLowerCase();return!(a==="localhost"||a.startsWith("127.")||a.startsWith("192.168.")||a.startsWith("10.")||a.match(/^172\.(1[6-9]|2[0-9]|3[01])\./)||/^\d+\.\d+\.\d+\.\d+$/.test(a))}catch(r){return!1}}function se(e){return!e||typeof e!="string"?!1:!!(/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(e)||/^rgba?\(\s*\d+\s*,\s*\d+\s*,\s*\d+/i.test(e)||/^hsla?\(\s*\d+/i.test(e))}function D(e,r){try{if(!("fills"in e))return n(`Layer "${e.name}" does not support fills`,"warning"),!1;const t=figma.util.solidPaint(r);return e.fills=[t],n(`Applied fill color "${r}" to layer "${e.name}"`,"info"),!0}catch(t){return n(`Invalid color value "${r}" for layer "${e.name}"`,"warning"),!1}}function L(e,r){try{if(!("strokes"in e))return!1;const t=e;if(!t.strokes||t.strokes.length===0)return!1;const a=figma.util.solidPaint(r);return t.strokes=[a],n(`Applied stroke color "${r}" to layer "${e.name}"`,"info"),!0}catch(t){return n(`Invalid stroke color "${r}" for layer "${e.name}"`,"warning"),!1}}class M{static isAllowed(r){const t=Date.now(),a=t-this.WINDOW_MS;this.requestHistory=this.requestHistory.filter(i=>i.timestamp>a);const s=this.extractDomain(r);return this.requestHistory.filter(i=>this.extractDomain(i.url)===s).length>=this.MAX_REQUESTS?!1:(this.requestHistory.push({url:r,timestamp:t}),!0)}static extractDomain(r){try{const t=r.match(/^https?:\/\/([a-zA-Z0-9.-]+)/);if(t&&t[1]){let a=t[1].toLowerCase();return a.includes("..")||a.startsWith(".")||a.endsWith(".")?"invalid":a}return"unknown"}catch(t){return"unknown"}}}M.requestHistory=[],M.MAX_REQUESTS=25,M.WINDOW_MS=6e4;function F(e,r){return r.split(".").reduce((a,s)=>{if(a==null)return;const o=s.match(/^(.+)\[(\d*)\]$/);if(o){const[,i,f]=o,g=a[i];return Array.isArray(g)?f===""?g[0]:g[parseInt(f)]:void 0}return a[s]},e)}function U(e,r){if(e.name===r)return e;if("children"in e)for(const t of e.children){const a=U(t,r);if(a)return a}return null}function _(e){const r=[];if((e.type==="INSTANCE"||e.type==="FRAME"||e.type==="GROUP"||e.type==="COMPONENT")&&r.push(e),"children"in e)for(const t of e.children)r.push(..._(t));return r}function V(e){const r=[];if(e.type==="INSTANCE"&&r.push(e),"children"in e)for(const t of e.children)r.push(...V(t));return r}function ie(e){const r=[];for(const t of e)if(t.type==="INSTANCE"||t.type==="FRAME"||t.type==="GROUP"||t.type==="COMPONENT")r.push(t);else{const a=_(t);r.push(...a)}return r}function be(e){const r=[];for(const t of e)if(t.type==="INSTANCE")r.push(t);else{const a=V(t);r.push(...a)}return r}function oe(e,r){try{const t=x(String(r));figma.loadFontAsync(e.fontName).then(()=>{e.characters=t,n(`\u{1F512} Applied sanitized text content (${t.length} chars)`,"info")})}catch(t){n("Failed to apply text content","error")}}const ce=["jsonplaceholder.typicode.com","api.github.com","httpbin.org","images.unsplash.com","via.placeholder.com","picsum.photos","loremflickr.com","dummyimage.com"];function v(e){try{const r=e.match(/^https?:\/\/([a-zA-Z0-9.-]+)/);return r?r[1]:null}catch(r){return null}}function S(e,r){let t=e.replace(/https?:\/\/[^\s]+/g,a=>{const s=v(a);return s?`[${s}]`:"[redacted-url]"});if(t=t.replace(/[?&](?:key|token|apikey|api_key|access_token)=[^&\s]+/gi,"[api-key-redacted]"),t=t.replace(/\/[a-zA-Z0-9._/-]+\.(js|ts|json|html)/g,"[file-path]"),r){const a=v(r);a&&(t=t.replace(/for [^\s:]+:?/g,`for ${a}:`))}return t}function q(e){try{if(!/^https:\/\/[a-zA-Z0-9.-]+(?:\.[a-zA-Z]{2,})+(?:\/.*)?$/.test(e))return{isValid:!1,error:"Invalid URL format - must be HTTPS"};const t=e.match(/^https:\/\/([a-zA-Z0-9.-]+)/);if(!t)return{isValid:!1,error:"Could not extract hostname from URL"};const a=t[1].toLowerCase();return a==="localhost"||a.startsWith("127.")||a.startsWith("192.168.")||a.startsWith("10.")||a.match(/^172\.(1[6-9]|2[0-9]|3[01])\./)?{isValid:!1,error:"Private/internal URLs are not allowed"}:["bit.ly","tinyurl.com","goo.gl","ow.ly","pastebin.com","hastebin.com"].some(o=>a.includes(o))?{isValid:!1,error:"Potentially unsafe domain blocked"}:/^\d+\.\d+\.\d+\.\d+$/.test(a)?{isValid:!1,error:"Direct IP addresses are not allowed"}:!a.includes(".")||a.endsWith(".")?{isValid:!1,error:"Invalid domain format"}:{isValid:!0}}catch(r){return{isValid:!1,error:`Invalid URL format: ${r instanceof Error?r.message:"Unknown error"}`}}}const z=new Set;function O(e){return u(this,null,function*(){return ce.includes(e)?!0:z.has(e)})}let d=null;const W=new Map,le=250,fe=3600*1e3,H=[];function ge(e){const r=Date.now(),t=W.get(e);return!t||r>t.resetTime?(W.set(e,{count:1,resetTime:r+fe}),!1):t.count>=le?!0:(t.count++,!1)}function K(e,r){return u(this,null,function*(){const t=v(e);return t?ge(t)?(figma.ui.postMessage({type:"log",level:"warning",message:`Rate limit exceeded for domain ${t}. Too many requests in the last hour.`}),!1):(d&&(clearTimeout(d.timeoutId),d.resolve(!1)),new Promise(a=>{figma.ui.postMessage({type:"request-domain-approval",url:e,domain:t,purpose:`${r} (WILDCARD ACCESS ENABLED - Extra caution advised)`});const s=setTimeout(()=>{d&&d.domain===t&&(d=null,H.push({domain:t,timestamp:Date.now(),approved:!1}),a(!1))},3e4);d={domain:t,resolve:o=>{H.push({domain:t,timestamp:Date.now(),approved:o}),a(o)},timeoutId:s}})):!1})}function ue(e,r){return u(this,null,function*(){try{if(!ne(r))return n("\u{1F6A8} SECURITY: Invalid or unsafe image URL","error"),!1;const t=r,a=q(t);if(!a.isValid)return n(`Invalid image URL: ${a.error}`,"error"),!1;const s=v(t);if(!s)return n("Unable to extract domain from URL","error"),!1;if(!(yield O(s))&&(n(`Domain ${s} not approved. Requesting approval...`,"warning"),!(yield K(r,"Image fetching"))))return n(`Domain ${s} was not approved by user`,"error"),!1;if(!M.isAllowed(t))return n("\u{1F6AB} Rate limit exceeded for this domain","warning"),!1;n(`\u{1F517} Fetching image from: ${t}`,"info");let i;try{i=yield figma.createImageAsync(t)}catch(f){return n(`Failed to create image from URL: ${S(f.message)}`,"error"),!1}if(!i||!i.hash)return n("Failed to create valid image object","error"),!1;if("fills"in e){const f=[{type:"IMAGE",scaleMode:"FILL",imageHash:i.hash}];return e.fills=f,n(`Successfully applied image from ${s}`,"info"),!0}else n(`Layer "${e.name}" does not support image fills`,"warning");return!1}catch(t){const a=t.message,s=v(r);if(n(`\u{1F6A8} Image fetch error for ${s}:`,"error"),n(`Error details: ${S(a,r)}`,"error"),a.includes("CORS"))n("\u274C CORS Error: Using figma.createImageAsync should avoid this","error"),n(`\u{1F4A1} Domain ${s} should be accessible`,"info");else if(t.rateLimitError){const o=t.retryAfter;n(o?`\u{1F6AB} Rate limit exceeded. Please wait ${o} seconds before trying again.`:`\u{1F6AB} Rate limit exceeded for ${s}`,"warning")}else a.includes("fetch")?n(`\u{1F310} Network error accessing ${s}`,"error"):n(`\u2753 Unknown error accessing ${s}`,"error");return!1}})}function de(e,r,t){try{if(e.variantProperties&&e.variantProperties[r]!==void 0){const a=x(t);if(a!==void 0)return e.setProperties({[r]:a}),n(`\u{1F512} Applied sanitized variant property: ${r} = ${a}`,"info"),!0}return!1}catch(a){return n("Failed to apply variant property","error"),!1}}function pe(e,r){return e.map(t=>t.type==="text"?t.value:t.type==="key"&&F(r,t.value)||"").join("")}function me(e,r,t){const a=t[e.jsonKey];return a?pe(a.parts,r):F(r,e.jsonKey)}function n(e,r="info"){figma.ui.postMessage({type:"log",message:e,level:r})}function ye(a,s){return u(this,arguments,function*(e,r,t={}){const o=figma.currentPage.selection;if(o.length===0){n("No layers selected. Please select one or more frames, groups, component instances, or other containers.","warning");return}const i=ie(o);if(i.length===0){n("No valid containers found in selection. Please select frames, groups, component instances, or other container nodes.","warning");return}let f=0;const g=i.length;n(`Found ${i.length} containers in selection. Starting to apply data...`,"info");for(let c=0;c<g;c++){const p=i[c],w=c%e.length,P=e[w];for(const m of r){const l=me(m,P,t);if(l==null){n(`Missing value for key "${m.jsonKey}" in data item ${c+1}`,"warning");continue}const y=U(p,m.layerName);if(!y){n(`Layer "${m.layerName}" not found in container "${p.name}"`,"warning");continue}if(typeof l=="string"&&(l.startsWith("http://")||l.startsWith("https://")))(yield ue(y,l))?n(`Applied image from URL to layer "${m.layerName}" in "${p.name}"`,"info"):n(`Failed to apply image from ${v(l)||"URL"} to layer "${m.layerName}" in "${p.name}"`,"error");else if(typeof l=="string"&&se(l)){const A=m.jsonKey.toLowerCase(),C=A.includes("stroke"),h=A.includes("fill");C&&!h?L(y,l):h&&!C?D(y,l):(D(y,l),L(y,l))}else if(y.type==="TEXT")oe(y,String(l)),n(`Applied text "${l}" to layer "${m.layerName}" in "${p.name}"`,"info");else if(y.type==="INSTANCE"&&typeof l=="string"){const A=y,C=Object.keys(A.variantProperties||{});if(C.length>0){const h=C.find(b=>b.toLowerCase()===m.layerName.toLowerCase()||m.layerName.toLowerCase().includes(b.toLowerCase()));h?de(A,h,l)?n(`Applied variant property "${h}" = "${l}" in "${p.name}"`,"info"):n(`Failed to apply variant property "${h}" = "${l}" in "${p.name}"`,"error"):n(`No matching variant property found for "${m.layerName}" in "${p.name}"`,"warning")}}}f++}if(i.length>e.length){const c=Math.ceil(i.length/e.length);n(`\u{1F4C4} Data cycling: Used ${e.length} data items across ${i.length} containers (${c} cycles)`,"info")}else e.length>i.length?n(`\u{1F4C4} Data usage: Used ${i.length} of ${e.length} available data items`,"info"):n(`\u{1F4C4} Perfect match: ${i.length} containers with ${e.length} data items`,"info");n(`\u2705 Completed! Processed ${f} containers (frames, groups, instances) across ${o.length} selected items.`,"info")})}function he(a,s){return u(this,arguments,function*(e,r,t={}){return ye(e,r,t)})}figma.showUI(__html__,{width:720,height:800,themeColors:!0});function ve(e){return u(this,null,function*(){try{const t=((yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[]).filter(s=>s.name!==e.name);t.unshift(e);const a=t.slice(0,20);yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",a),figma.ui.postMessage({type:"config-saved",data:a,message:`Configuration "${e.name}" saved successfully`})}catch(r){figma.ui.postMessage({type:"storage-error",message:"Failed to save configuration"})}})}function R(){return u(this,null,function*(){try{const e=(yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[],r=ae(e),{cleanedConfigurations:t,migrationSummary:a}=r;a.migratedConfigs>0&&(yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",t),figma.ui.postMessage({type:"log",message:`Security migration: Cleaned ${a.migratedConfigs} configurations by removing API credentials`,level:"info"})),figma.ui.postMessage({type:"configs-loaded",data:t})}catch(e){figma.ui.postMessage({type:"storage-error",message:`Failed to load configurations: ${e instanceof Error?e.message:"Unknown error"}`})}})}function we(e){return u(this,null,function*(){try{const t=((yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[]).filter(a=>a.name!==e);yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",t),figma.ui.postMessage({type:"config-deleted",data:t,message:`Configuration "${e}" deleted`})}catch(r){figma.ui.postMessage({type:"storage-error",message:"Failed to delete configuration"})}})}function Ae(){return u(this,null,function*(){try{yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",[]),figma.ui.postMessage({type:"configs-cleared",data:[],message:"All configurations cleared"})}catch(e){figma.ui.postMessage({type:"storage-error",message:"Failed to clear configurations"})}})}function j(e){z.add(e)}function Se(e){return u(this,null,function*(){try{const{url:r,method:t="GET",headers:a={},requestId:s}=e,o=q(r);if(!o.isValid){figma.ui.postMessage({type:"api-fetch-error",requestId:s,error:o.error});return}const i=v(r);if(!i){figma.ui.postMessage({type:"api-fetch-error",requestId:s,error:"Unable to extract domain from URL"});return}if(!(yield O(i))&&(n(`Domain ${i} not approved. Requesting approval...`,"warning"),!(yield K(r,"API data fetching")))){figma.ui.postMessage({type:"api-fetch-error",requestId:s,error:`Domain ${i} was not approved by user`});return}const g=Object.assign({"User-Agent":"FigmaPlugin-Struct/1.0"},a);if(typeof fetch=="undefined")throw new Error("Fetch API is not available in this context");const c=yield fetch(r,{method:t,headers:g});if(!c)throw new Error("Response object is undefined");if(!c.ok)throw new Error(`HTTP ${c.status}: ${c.statusText}`);const p=c.headers&&c.headers.get&&c.headers.get("content-type")||"";let w;if(p.includes("application/json"))w=yield c.json();else{const $=yield c.text();try{w=JSON.parse($)}catch(P){w=$}}figma.ui.postMessage({type:"api-fetch-success",requestId:s,data:w,contentType:p}),n(`Successfully fetched data from ${i}`,"info")}catch(r){const t=r instanceof Error?r.message:"Unknown error";figma.ui.postMessage({type:"api-fetch-error",requestId:e.requestId,error:t}),n(`API fetch failed: ${S(t)}`,"error")}})}function Ce(e){return u(this,null,function*(){try{const{key:r,value:t}=e;if(!r)throw new Error("Storage key is required");yield figma.clientStorage.setAsync(r,t),figma.ui.postMessage({type:"storage-save-response",key:r,success:!0}),n(`Secure storage save completed for key: ${r}`,"info")}catch(r){const t=r instanceof Error?r.message:"Storage save failed";figma.ui.postMessage({type:"storage-save-response",key:e.key,success:!1,error:t}),n(`Secure storage save failed: ${S(t)}`,"error")}})}function $e(e){return u(this,null,function*(){try{const{key:r}=e;if(!r)throw new Error("Storage key is required");const t=yield figma.clientStorage.getAsync(r);figma.ui.postMessage({type:"storage-load-response",key:r,success:!0,value:t}),n(`Secure storage load completed for key: ${r}`,"info")}catch(r){const t=r instanceof Error?r.message:"Storage load failed";figma.ui.postMessage({type:"storage-load-response",key:e.key,success:!1,error:t,value:null}),n(`Secure storage load failed: ${S(t)}`,"error")}})}figma.ui.onmessage=e=>u(null,null,function*(){switch(e.type){case"apply-data":const{jsonData:r,mappings:t,valueBuilders:a}=e;yield he(r,t,a||{});break;case"save-config":yield ve(e.data);break;case"load-configs":yield R();break;case"delete-config":yield we(e.configName);break;case"clear-configs":yield Ae();break;case"approve-domain":j(e.domain);break;case"domain-approval-response":d&&d.domain===e.domain&&(clearTimeout(d.timeoutId),e.approved?(j(e.domain),d.resolve(!0)):d.resolve(!1),d=null);break;case"fetch-api-data":yield Se(e);break;case"storage-save-request":yield Ce(e);break;case"storage-load-request":yield $e(e);break;case"close":figma.closePlugin();break;default:break}}),figma.on("selectionchange",()=>{figma.ui.postMessage({type:"selection-changed",selectionCount:figma.currentPage.selection.length})}),u(null,null,function*(){try{yield R(),n("\u{1F4CA} Storage initialized with basic security","info")}catch(e){n(`\u26A0\uFE0F Storage initialization failed: ${e instanceof Error?S(e.message):"Unknown error"}`,"warning"),yield R()}});try{figma.ui.postMessage({type:"selection-changed",selectionCount:figma.currentPage.selection.length})}catch(e){figma.ui.postMessage({type:"selection-changed",selectionCount:0})}
