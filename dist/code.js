"use strict";var K=Object.defineProperty,O=Object.defineProperties;var j=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var x=(e,a,t)=>a in e?K(e,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[a]=t,b=(e,a)=>{for(var t in a||(a={}))B.call(a,t)&&x(e,t,a[t]);if(P)for(var t of P(a))J.call(a,t)&&x(e,t,a[t]);return e},I=(e,a)=>O(e,j(a));var f=(e,a,t)=>new Promise((r,s)=>{var o=g=>{try{l(t.next(g))}catch(c){s(c)}},i=g=>{try{l(t.throw(g))}catch(c){s(c)}},l=g=>g.done?r(g.value):Promise.resolve(g.value).then(o,i);l((t=t.apply(e,a)).next())});const Z=[/authorization/i,/auth/i,/token/i,/key/i,/secret/i,/bearer/i,/api[_-]?key/i,/x-api[_-]?key/i,/access[_-]?token/i,/refresh[_-]?token/i,/session[_-]?token/i,/csrf[_-]?token/i,/jwt/i,/oauth/i,/credential/i,/password/i,/passwd/i,/pwd/i];function k(e){return Z.some(a=>a.test(e))}function X(e){const a={};for(const[t,r]of Object.entries(e||{}))k(t)||(a[t]=r);return a}function Q(e){return I(b({},e),{apiKey:"",headers:X(e.headers)})}function G(e){const{apiConfig:a}=e;return!!(a.apiKey&&a.apiKey.trim()!==""||Object.keys(a.headers||{}).some(r=>k(r)))}function Y(e){return I(b({},e),{apiConfig:Q(e.apiConfig)})}function ee(e){const a=[];let t=0,r=0,s=0;for(const o of e)if(G(o)){o.apiConfig.apiKey&&o.apiConfig.apiKey.trim()!==""&&r++;const i=Object.keys(o.apiConfig.headers||{}).filter(l=>k(l));s+=i.length,t++,a.push(Y(o))}else a.push(o);return{cleanedConfigurations:a,migrationSummary:{totalConfigs:e.length,migratedConfigs:t,removedApiKeys:r,removedHeaders:s}}}function D(e){if(!e||typeof e!="string")return"";const a=e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),t=5e4;return a.length>t?a.substring(0,t):a}function te(e){if(!e||typeof e!="string")return!1;try{const a=/^https:\/\/([a-zA-Z0-9.-]+)(?::\d+)?(?:\/.*)?$/,t=e.match(a);if(!t)return!1;const r=t[1].toLowerCase();return!(r==="localhost"||r.startsWith("127.")||r.startsWith("192.168.")||r.startsWith("10.")||r.match(/^172\.(1[6-9]|2[0-9]|3[01])\./)||/^\d+\.\d+\.\d+\.\d+$/.test(r))}catch(a){return!1}}class ${static isAllowed(a){const t=Date.now(),r=t-this.WINDOW_MS;this.requestHistory=this.requestHistory.filter(i=>i.timestamp>r);const s=this.extractDomain(a);return this.requestHistory.filter(i=>this.extractDomain(i.url)===s).length>=this.MAX_REQUESTS?!1:(this.requestHistory.push({url:a,timestamp:t}),!0)}static extractDomain(a){try{const t=a.match(/^https?:\/\/([a-zA-Z0-9.-]+)/);if(t&&t[1]){let r=t[1].toLowerCase();return r.includes("..")||r.startsWith(".")||r.endsWith(".")?"invalid":r}return"unknown"}catch(t){return"unknown"}}}$.requestHistory=[],$.MAX_REQUESTS=25,$.WINDOW_MS=6e4;function T(e,a){return a.split(".").reduce((r,s)=>{if(r==null)return;const o=s.match(/^(.+)\[(\d*)\]$/);if(o){const[,i,l]=o,g=r[i];return Array.isArray(g)?l===""?g[0]:g[parseInt(l)]:void 0}return r[s]},e)}function L(e,a){if(e.name===a)return e;if("children"in e)for(const t of e.children){const r=L(t,a);if(r)return r}return null}function U(e){const a=[];if(e.type==="INSTANCE"&&a.push(e),"children"in e)for(const t of e.children)a.push(...U(t));return a}function ae(e){const a=[];for(const t of e)if(t.type==="INSTANCE")a.push(t);else{const r=U(t);a.push(...r)}return a}function re(e,a){try{const t=D(String(a));figma.loadFontAsync(e.fontName).then(()=>{e.characters=t,n(`\u{1F512} Applied sanitized text content (${t.length} chars)`,"info")})}catch(t){n("Failed to apply text content","error")}}const ne=["jsonplaceholder.typicode.com","api.github.com","httpbin.org","images.unsplash.com","via.placeholder.com","picsum.photos","loremflickr.com","dummyimage.com"];function y(e){try{const a=e.match(/^https?:\/\/([a-zA-Z0-9.-]+)/);return a?a[1]:null}catch(a){return null}}function w(e,a){let t=e.replace(/https?:\/\/[^\s]+/g,r=>{const s=y(r);return s?`[${s}]`:"[redacted-url]"});if(t=t.replace(/[?&](?:key|token|apikey|api_key|access_token)=[^&\s]+/gi,"[api-key-redacted]"),t=t.replace(/\/[a-zA-Z0-9._/-]+\.(js|ts|json|html)/g,"[file-path]"),a){const r=y(a);r&&(t=t.replace(/for [^\s:]+:?/g,`for ${r}:`))}return t}function V(e){try{if(!/^https:\/\/[a-zA-Z0-9.-]+(?:\.[a-zA-Z]{2,})+(?:\/.*)?$/.test(e))return{isValid:!1,error:"Invalid URL format - must be HTTPS"};const t=e.match(/^https:\/\/([a-zA-Z0-9.-]+)/);if(!t)return{isValid:!1,error:"Could not extract hostname from URL"};const r=t[1].toLowerCase();return r==="localhost"||r.startsWith("127.")||r.startsWith("192.168.")||r.startsWith("10.")||r.match(/^172\.(1[6-9]|2[0-9]|3[01])\./)?{isValid:!1,error:"Private/internal URLs are not allowed"}:["bit.ly","tinyurl.com","goo.gl","ow.ly","pastebin.com","hastebin.com"].some(o=>r.includes(o))?{isValid:!1,error:"Potentially unsafe domain blocked"}:/^\d+\.\d+\.\d+\.\d+$/.test(r)?{isValid:!1,error:"Direct IP addresses are not allowed"}:!r.includes(".")||r.endsWith(".")?{isValid:!1,error:"Invalid domain format"}:{isValid:!0}}catch(a){return{isValid:!1,error:`Invalid URL format: ${a instanceof Error?a.message:"Unknown error"}`}}}const F=new Set;function _(e){return f(this,null,function*(){return ne.includes(e)?!0:F.has(e)})}let d=null;const q=new Map,se=250,ie=3600*1e3,z=[];function oe(e){const a=Date.now(),t=q.get(e);return!t||a>t.resetTime?(q.set(e,{count:1,resetTime:a+ie}),!1):t.count>=se?!0:(t.count++,!1)}function H(e,a){return f(this,null,function*(){const t=y(e);return t?oe(t)?(figma.ui.postMessage({type:"log",level:"warning",message:`Rate limit exceeded for domain ${t}. Too many requests in the last hour.`}),!1):(d&&(clearTimeout(d.timeoutId),d.resolve(!1)),new Promise(r=>{figma.ui.postMessage({type:"request-domain-approval",url:e,domain:t,purpose:`${a} (WILDCARD ACCESS ENABLED - Extra caution advised)`});const s=setTimeout(()=>{d&&d.domain===t&&(d=null,z.push({domain:t,timestamp:Date.now(),approved:!1}),r(!1))},3e4);d={domain:t,resolve:o=>{z.push({domain:t,timestamp:Date.now(),approved:o}),r(o)},timeoutId:s}})):!1})}function ce(e,a){return f(this,null,function*(){try{if(!te(a))return n("\u{1F6A8} SECURITY: Invalid or unsafe image URL","error"),!1;const t=a,r=V(t);if(!r.isValid)return n(`Invalid image URL: ${r.error}`,"error"),!1;const s=y(t);if(!s)return n("Unable to extract domain from URL","error"),!1;if(!(yield _(s))&&(n(`Domain ${s} not approved. Requesting approval...`,"warning"),!(yield H(a,"Image fetching"))))return n(`Domain ${s} was not approved by user`,"error"),!1;if(!$.isAllowed(t))return n("\u{1F6AB} Rate limit exceeded for this domain","warning"),!1;n(`\u{1F517} Fetching image from: ${t}`,"info");let i;try{i=yield figma.createImageAsync(t)}catch(l){return n(`Failed to create image from URL: ${w(l.message)}`,"error"),!1}if(!i||!i.hash)return n("Failed to create valid image object","error"),!1;if("fills"in e){const l=[{type:"IMAGE",scaleMode:"FILL",imageHash:i.hash}];return e.fills=l,n(`Successfully applied image from ${s}`,"info"),!0}else n(`Layer "${e.name}" does not support image fills`,"warning");return!1}catch(t){const r=t.message,s=y(a);if(n(`\u{1F6A8} Image fetch error for ${s}:`,"error"),n(`Error details: ${w(r,a)}`,"error"),r.includes("CORS"))n("\u274C CORS Error: Using figma.createImageAsync should avoid this","error"),n(`\u{1F4A1} Domain ${s} should be accessible`,"info");else if(t.rateLimitError){const o=t.retryAfter;n(o?`\u{1F6AB} Rate limit exceeded. Please wait ${o} seconds before trying again.`:`\u{1F6AB} Rate limit exceeded for ${s}`,"warning")}else r.includes("fetch")?n(`\u{1F310} Network error accessing ${s}`,"error"):n(`\u2753 Unknown error accessing ${s}`,"error");return!1}})}function le(e,a,t){try{if(e.variantProperties&&e.variantProperties[a]!==void 0){const r=D(t);if(r!==void 0)return e.setProperties({[a]:r}),n(`\u{1F512} Applied sanitized variant property: ${a} = ${r}`,"info"),!0}return!1}catch(r){return n("Failed to apply variant property","error"),!1}}function ge(e,a){return e.map(t=>t.type==="text"?t.value:t.type==="key"&&T(a,t.value)||"").join("")}function fe(e,a,t){const r=t[e.jsonKey];return r?ge(r.parts,a):T(a,e.jsonKey)}function n(e,a="info"){figma.ui.postMessage({type:"log",message:e,level:a})}function ue(r,s){return f(this,arguments,function*(e,a,t={}){const o=figma.currentPage.selection;if(o.length===0){n("No layers selected. Please select one or more component instances, groups, or frames.","warning");return}const i=ae(o);if(i.length===0){n("No component instances found in selection. Please select component instances or containers with component instances.","warning");return}let l=0;const g=i.length;n(`Found ${i.length} component instances in selection. Starting to apply data...`,"info");for(let c=0;c<g;c++){const p=i[c],h=c%e.length,N=e[h];for(const m of a){const u=fe(m,N,t);if(u==null){n(`Missing value for key "${m.jsonKey}" in data item ${c+1}`,"warning");continue}const v=L(p,m.layerName);if(!v){n(`Layer "${m.layerName}" not found in instance "${p.name}"`,"warning");continue}if(v.type==="TEXT")re(v,String(u)),n(`Applied text "${u}" to layer "${m.layerName}" in "${p.name}"`,"info");else if(typeof u=="string"&&(u.startsWith("http://")||u.startsWith("https://")))(yield ce(v,u))?n(`Applied image from URL to layer "${m.layerName}" in "${p.name}"`,"info"):n(`Failed to apply image from ${y(u)||"URL"} to layer "${m.layerName}" in "${p.name}"`,"error");else if(v.type==="INSTANCE"&&typeof u=="string"){const C=v,E=Object.keys(C.variantProperties||{});if(E.length>0){const S=E.find(M=>M.toLowerCase()===m.layerName.toLowerCase()||m.layerName.toLowerCase().includes(M.toLowerCase()));S?le(C,S,u)?n(`Applied variant property "${S}" = "${u}" in "${p.name}"`,"info"):n(`Failed to apply variant property "${S}" = "${u}" in "${p.name}"`,"error"):n(`No matching variant property found for "${m.layerName}" in "${p.name}"`,"warning")}}}l++}if(i.length>e.length){const c=Math.ceil(i.length/e.length);n(`\u{1F4C4} Data cycling: Used ${e.length} data items across ${i.length} instances (${c} cycles)`,"info")}else e.length>i.length?n(`\u{1F4C4} Data usage: Used ${i.length} of ${e.length} available data items`,"info"):n(`\u{1F4C4} Perfect match: ${i.length} instances with ${e.length} data items`,"info");n(`\u2705 Completed! Processed ${l} component instances across ${o.length} selected containers.`,"info")})}figma.showUI(__html__,{width:720,height:800,themeColors:!0});function de(e){return f(this,null,function*(){try{const t=((yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[]).filter(s=>s.name!==e.name);t.unshift(e);const r=t.slice(0,20);yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",r),figma.ui.postMessage({type:"config-saved",data:r,message:`Configuration "${e.name}" saved successfully`})}catch(a){figma.ui.postMessage({type:"storage-error",message:"Failed to save configuration"})}})}function R(){return f(this,null,function*(){try{const e=(yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[],a=ee(e),{cleanedConfigurations:t,migrationSummary:r}=a;r.migratedConfigs>0&&(yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",t),figma.ui.postMessage({type:"log",message:`Security migration: Cleaned ${r.migratedConfigs} configurations by removing API credentials`,level:"info"})),figma.ui.postMessage({type:"configs-loaded",data:t})}catch(e){figma.ui.postMessage({type:"storage-error",message:`Failed to load configurations: ${e instanceof Error?e.message:"Unknown error"}`})}})}function pe(e){return f(this,null,function*(){try{const t=((yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[]).filter(r=>r.name!==e);yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",t),figma.ui.postMessage({type:"config-deleted",data:t,message:`Configuration "${e}" deleted`})}catch(a){figma.ui.postMessage({type:"storage-error",message:"Failed to delete configuration"})}})}function me(){return f(this,null,function*(){try{yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",[]),figma.ui.postMessage({type:"configs-cleared",data:[],message:"All configurations cleared"})}catch(e){figma.ui.postMessage({type:"storage-error",message:"Failed to clear configurations"})}})}function W(e){F.add(e)}function ye(e){return f(this,null,function*(){try{const{url:a,method:t="GET",headers:r={},requestId:s}=e,o=V(a);if(!o.isValid){figma.ui.postMessage({type:"api-fetch-error",requestId:s,error:o.error});return}const i=y(a);if(!i){figma.ui.postMessage({type:"api-fetch-error",requestId:s,error:"Unable to extract domain from URL"});return}if(!(yield _(i))&&(n(`Domain ${i} not approved. Requesting approval...`,"warning"),!(yield H(a,"API data fetching")))){figma.ui.postMessage({type:"api-fetch-error",requestId:s,error:`Domain ${i} was not approved by user`});return}const g=Object.assign({"User-Agent":"FigmaPlugin-Struct/1.0"},r);if(typeof fetch=="undefined")throw new Error("Fetch API is not available in this context");const c=yield fetch(a,{method:t,headers:g});if(!c)throw new Error("Response object is undefined");if(!c.ok)throw new Error(`HTTP ${c.status}: ${c.statusText}`);const p=c.headers&&c.headers.get&&c.headers.get("content-type")||"";let h;if(p.includes("application/json"))h=yield c.json();else{const A=yield c.text();try{h=JSON.parse(A)}catch(N){h=A}}figma.ui.postMessage({type:"api-fetch-success",requestId:s,data:h,contentType:p}),n(`Successfully fetched data from ${i}`,"info")}catch(a){const t=a instanceof Error?a.message:"Unknown error";figma.ui.postMessage({type:"api-fetch-error",requestId:e.requestId,error:t}),n(`API fetch failed: ${w(t)}`,"error")}})}function he(e){return f(this,null,function*(){try{const{key:a,value:t}=e;if(!a)throw new Error("Storage key is required");yield figma.clientStorage.setAsync(a,t),figma.ui.postMessage({type:"storage-save-response",key:a,success:!0}),n(`Secure storage save completed for key: ${a}`,"info")}catch(a){const t=a instanceof Error?a.message:"Storage save failed";figma.ui.postMessage({type:"storage-save-response",key:e.key,success:!1,error:t}),n(`Secure storage save failed: ${w(t)}`,"error")}})}function ve(e){return f(this,null,function*(){try{const{key:a}=e;if(!a)throw new Error("Storage key is required");const t=yield figma.clientStorage.getAsync(a);figma.ui.postMessage({type:"storage-load-response",key:a,success:!0,value:t}),n(`Secure storage load completed for key: ${a}`,"info")}catch(a){const t=a instanceof Error?a.message:"Storage load failed";figma.ui.postMessage({type:"storage-load-response",key:e.key,success:!1,error:t,value:null}),n(`Secure storage load failed: ${w(t)}`,"error")}})}figma.ui.onmessage=e=>f(null,null,function*(){switch(e.type){case"apply-data":const{jsonData:a,mappings:t,valueBuilders:r}=e;yield ue(a,t,r||{});break;case"save-config":yield de(e.data);break;case"load-configs":yield R();break;case"delete-config":yield pe(e.configName);break;case"clear-configs":yield me();break;case"approve-domain":W(e.domain);break;case"domain-approval-response":d&&d.domain===e.domain&&(clearTimeout(d.timeoutId),e.approved?(W(e.domain),d.resolve(!0)):d.resolve(!1),d=null);break;case"fetch-api-data":yield ye(e);break;case"storage-save-request":yield he(e);break;case"storage-load-request":yield ve(e);break;case"close":figma.closePlugin();break;default:break}}),figma.on("selectionchange",()=>{figma.ui.postMessage({type:"selection-changed",selectionCount:figma.currentPage.selection.length})}),f(null,null,function*(){try{yield R(),n("\u{1F4CA} Storage initialized with basic security","info")}catch(e){n(`\u26A0\uFE0F Storage initialization failed: ${e instanceof Error?w(e.message):"Unknown error"}`,"warning"),yield R()}});try{figma.ui.postMessage({type:"selection-changed",selectionCount:figma.currentPage.selection.length})}catch(e){figma.ui.postMessage({type:"selection-changed",selectionCount:0})}
