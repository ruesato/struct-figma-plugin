"use strict";var G=Object.defineProperty,Z=Object.defineProperties;var Q=Object.getOwnPropertyDescriptors;var E=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var x=(e,r,t)=>r in e?G(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,N=(e,r)=>{for(var t in r||(r={}))X.call(r,t)&&x(e,t,r[t]);if(E)for(var t of E(r))Y.call(r,t)&&x(e,t,r[t]);return e},I=(e,r)=>Z(e,Q(r));var p=(e,r,t)=>new Promise((n,i)=>{var o=u=>{try{s(t.next(u))}catch(m){i(m)}},c=u=>{try{s(t.throw(u))}catch(m){i(m)}},s=u=>u.done?n(u.value):Promise.resolve(u.value).then(o,c);s((t=t.apply(e,r)).next())});const ee=[/authorization/i,/auth/i,/token/i,/key/i,/secret/i,/bearer/i,/api[_-]?key/i,/x-api[_-]?key/i,/access[_-]?token/i,/refresh[_-]?token/i,/session[_-]?token/i,/csrf[_-]?token/i,/jwt/i,/oauth/i,/credential/i,/password/i,/passwd/i,/pwd/i];function P(e){return ee.some(r=>r.test(e))}function te(e){const r={};for(const[t,n]of Object.entries(e||{}))P(t)||(r[t]=n);return r}function re(e){return I(N({},e),{apiKey:"",headers:te(e.headers)})}function ne(e){const{apiConfig:r}=e;return!!(r.apiKey&&r.apiKey.trim()!==""||Object.keys(r.headers||{}).some(n=>P(n)))}function ae(e){return I(N({},e),{apiConfig:re(e.apiConfig)})}function ie(e){const r=[];let t=0,n=0,i=0;for(const o of e)if(ne(o)){o.apiConfig.apiKey&&o.apiConfig.apiKey.trim()!==""&&n++;const c=Object.keys(o.apiConfig.headers||{}).filter(s=>P(s));i+=c.length,t++,r.push(ae(o))}else r.push(o);return{cleanedConfigurations:r,migrationSummary:{totalConfigs:e.length,migratedConfigs:t,removedApiKeys:n,removedHeaders:i}}}function T(e){if(!e||typeof e!="string")return"";const r=e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),t=5e4;return r.length>t?r.substring(0,t):r}function se(e){if(!e||typeof e!="string")return!1;try{const r=/^https:\/\/([a-zA-Z0-9.-]+)(?::\d+)?(?:\/.*)?$/,t=e.match(r);if(!t)return!1;const n=t[1].toLowerCase();return!(n==="localhost"||n.startsWith("127.")||n.startsWith("192.168.")||n.startsWith("10.")||n.match(/^172\.(1[6-9]|2[0-9]|3[01])\./)||/^\d+\.\d+\.\d+\.\d+$/.test(n))}catch(r){return!1}}function oe(e){return!e||typeof e!="string"?!1:!!(/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(e)||/^rgba?\(\s*\d+\s*,\s*\d+\s*,\s*\d+/i.test(e)||/^hsla?\(\s*\d+/i.test(e))}function ce(e){if(!e||typeof e!="string"||!e.startsWith("http://")&&!e.startsWith("https://"))return!1;const t=e.split("?")[0].split("#")[0].toLowerCase();return t.endsWith(".png")||t.endsWith(".jpg")||t.endsWith(".jpeg")||t.endsWith(".gif")||t.endsWith(".webp")||t.endsWith(".svg")}function le(e){if(!e||typeof e!="string"||e.startsWith("http://")||e.startsWith("https://"))return!1;const r=e.toLowerCase();return r.endsWith(".png")||r.endsWith(".jpg")||r.endsWith(".jpeg")||r.endsWith(".gif")||r.endsWith(".webp")}function fe(e){if(!e||typeof e!="string")return"";const r=Math.max(e.lastIndexOf("/"),e.lastIndexOf("\\"));return r===-1?e:e.substring(r+1)}function F(e,r){try{if(!("fills"in e))return a(`Layer "${e.name}" does not support fills`,"warning"),!1;const t=figma.util.solidPaint(r);return e.fills=[t],a(`Applied fill color "${r}" to layer "${e.name}"`,"info"),!0}catch(t){return a(`Invalid color value "${r}" for layer "${e.name}"`,"warning"),!1}}function L(e,r){try{if(!("strokes"in e))return!1;const t=e;if(!t.strokes||t.strokes.length===0)return!1;const n=figma.util.solidPaint(r);return t.strokes=[n],a(`Applied stroke color "${r}" to layer "${e.name}"`,"info"),!0}catch(t){return a(`Invalid stroke color "${r}" for layer "${e.name}"`,"warning"),!1}}class M{static isAllowed(r){const t=Date.now(),n=t-this.WINDOW_MS;this.requestHistory=this.requestHistory.filter(c=>c.timestamp>n);const i=this.extractDomain(r);return this.requestHistory.filter(c=>this.extractDomain(c.url)===i).length>=this.MAX_REQUESTS?!1:(this.requestHistory.push({url:r,timestamp:t}),!0)}static extractDomain(r){try{const t=r.match(/^https?:\/\/([a-zA-Z0-9.-]+)/);if(t&&t[1]){let n=t[1].toLowerCase();return n.includes("..")||n.startsWith(".")||n.endsWith(".")?"invalid":n}return"unknown"}catch(t){return"unknown"}}}M.requestHistory=[],M.MAX_REQUESTS=25,M.WINDOW_MS=6e4;function D(e,r){return r.split(".").reduce((n,i)=>{if(n==null)return;const o=i.match(/^(.+)\[(\d*)\]$/);if(o){const[,c,s]=o,u=n[c];return Array.isArray(u)?s===""?u[0]:u[parseInt(s)]:void 0}return n[i]},e)}function j(e,r){if(e.name===r)return e;if("children"in e)for(const t of e.children){const n=j(t,r);if(n)return n}return null}function U(e){const r=[];if((e.type==="INSTANCE"||e.type==="FRAME"||e.type==="GROUP"||e.type==="COMPONENT")&&r.push(e),"children"in e)for(const t of e.children)r.push(...U(t));return r}function W(e){const r=[];if(e.type==="INSTANCE"&&r.push(e),"children"in e)for(const t of e.children)r.push(...W(t));return r}function ge(e){const r=[];for(const t of e)if(t.type==="INSTANCE"||t.type==="FRAME"||t.type==="GROUP"||t.type==="COMPONENT")r.push(t);else{const n=U(t);r.push(...n)}return r}function xe(e){const r=[];for(const t of e)if(t.type==="INSTANCE")r.push(t);else{const n=W(t);r.push(...n)}return r}function ue(e,r){try{const t=T(String(r));figma.loadFontAsync(e.fontName).then(()=>{e.characters=t,a(`\u{1F512} Applied sanitized text content (${t.length} chars)`,"info")})}catch(t){a("Failed to apply text content","error")}}const de=["jsonplaceholder.typicode.com","api.github.com","httpbin.org","images.unsplash.com","via.placeholder.com","picsum.photos","loremflickr.com","dummyimage.com"];function A(e){try{const r=e.match(/^https?:\/\/([a-zA-Z0-9.-]+)/);return r?r[1]:null}catch(r){return null}}function S(e,r){let t=e.replace(/https?:\/\/[^\s]+/g,n=>{const i=A(n);return i?`[${i}]`:"[redacted-url]"});if(t=t.replace(/[?&](?:key|token|apikey|api_key|access_token)=[^&\s]+/gi,"[api-key-redacted]"),t=t.replace(/\/[a-zA-Z0-9._/-]+\.(js|ts|json|html)/g,"[file-path]"),r){const n=A(r);n&&(t=t.replace(/for [^\s:]+:?/g,`for ${n}:`))}return t}function O(e){try{if(!/^https:\/\/[a-zA-Z0-9.-]+(?:\.[a-zA-Z]{2,})+(?:\/.*)?$/.test(e))return{isValid:!1,error:"Invalid URL format - must be HTTPS"};const t=e.match(/^https:\/\/([a-zA-Z0-9.-]+)/);if(!t)return{isValid:!1,error:"Could not extract hostname from URL"};const n=t[1].toLowerCase();return n==="localhost"||n.startsWith("127.")||n.startsWith("192.168.")||n.startsWith("10.")||n.match(/^172\.(1[6-9]|2[0-9]|3[01])\./)?{isValid:!1,error:"Private/internal URLs are not allowed"}:["bit.ly","tinyurl.com","goo.gl","ow.ly","pastebin.com","hastebin.com"].some(o=>n.includes(o))?{isValid:!1,error:"Potentially unsafe domain blocked"}:/^\d+\.\d+\.\d+\.\d+$/.test(n)?{isValid:!1,error:"Direct IP addresses are not allowed"}:!n.includes(".")||n.endsWith(".")?{isValid:!1,error:"Invalid domain format"}:{isValid:!0}}catch(r){return{isValid:!1,error:`Invalid URL format: ${r instanceof Error?r.message:"Unknown error"}`}}}const V=new Set;function K(e){return p(this,null,function*(){return de.includes(e)?!0:V.has(e)})}let h=null;const _=new Map,pe=250,me=3600*1e3,q=[];function ye(e){const r=Date.now(),t=_.get(e);return!t||r>t.resetTime?(_.set(e,{count:1,resetTime:r+me}),!1):t.count>=pe?!0:(t.count++,!1)}function z(e,r){return p(this,null,function*(){const t=A(e);return t?ye(t)?(figma.ui.postMessage({type:"log",level:"warning",message:`Rate limit exceeded for domain ${t}. Too many requests in the last hour.`}),!1):(h&&(clearTimeout(h.timeoutId),h.resolve(!1)),new Promise(n=>{figma.ui.postMessage({type:"request-domain-approval",url:e,domain:t,purpose:`${r} (WILDCARD ACCESS ENABLED - Extra caution advised)`});const i=setTimeout(()=>{h&&h.domain===t&&(h=null,q.push({domain:t,timestamp:Date.now(),approved:!1}),n(!1))},3e4);h={domain:t,resolve:o=>{q.push({domain:t,timestamp:Date.now(),approved:o}),n(o)},timeoutId:i}})):!1})}function B(e,r){const t=Array.isArray(e.fills)?e.fills.find(n=>n.type==="IMAGE"):void 0;if(t){const n={type:"IMAGE",imageHash:r,scaleMode:t.scaleMode};return t.imageTransform!==void 0&&(n.imageTransform=t.imageTransform),t.scalingFactor!==void 0&&(n.scalingFactor=t.scalingFactor),t.rotation!==void 0&&(n.rotation=t.rotation),t.filters!==void 0&&(n.filters=t.filters),t.opacity!==void 0&&(n.opacity=t.opacity),t.blendMode!==void 0&&(n.blendMode=t.blendMode),t.visible!==void 0&&(n.visible=t.visible),n}return{type:"IMAGE",scaleMode:"FILL",imageHash:r}}function he(e,r){return p(this,null,function*(){try{if(!("fills"in e))return a(`Layer "${e.name}" does not support image fills`,"warning"),!1;let t;try{t=figma.createImage(r)}catch(i){return a(`Failed to create image from bytes: ${i.message}`,"error"),!1}if(!t||!t.hash)return a("Failed to create valid image object from bytes","error"),!1;const n=B(e,t.hash);return e.fills=[n],a(`Successfully applied image from local file to "${e.name}"`,"info"),!0}catch(t){const n=t.message;return a(`Failed to apply image from bytes: ${n}`,"error"),!1}})}function we(e,r){return p(this,null,function*(){try{if(!se(r))return a("\u{1F6A8} SECURITY: Invalid or unsafe image URL","error"),!1;const t=r,n=O(t);if(!n.isValid)return a(`Invalid image URL: ${n.error}`,"error"),!1;const i=A(t);if(!i)return a("Unable to extract domain from URL","error"),!1;if(!(yield K(i))&&(a(`Domain ${i} not approved. Requesting approval...`,"warning"),!(yield z(r,"Image fetching"))))return a(`Domain ${i} was not approved by user`,"error"),!1;if(!M.isAllowed(t))return a("\u{1F6AB} Rate limit exceeded for this domain","warning"),!1;a(`\u{1F517} Fetching image from: ${t}`,"info");let c;try{c=yield figma.createImageAsync(t)}catch(s){return a(`Failed to create image from URL: ${S(s.message)}`,"error"),!1}if(!c||!c.hash)return a("Failed to create valid image object","error"),!1;if("fills"in e){const s=B(e,c.hash);return e.fills=[s],a(`Successfully applied image from ${i}`,"info"),!0}else a(`Layer "${e.name}" does not support image fills`,"warning");return!1}catch(t){const n=t.message,i=A(r);if(a(`\u{1F6A8} Image fetch error for ${i}:`,"error"),a(`Error details: ${S(n,r)}`,"error"),n.includes("CORS"))a("\u274C CORS Error: Using figma.createImageAsync should avoid this","error"),a(`\u{1F4A1} Domain ${i} should be accessible`,"info");else if(t.rateLimitError){const o=t.retryAfter;a(o?`\u{1F6AB} Rate limit exceeded. Please wait ${o} seconds before trying again.`:`\u{1F6AB} Rate limit exceeded for ${i}`,"warning")}else n.includes("fetch")?a(`\u{1F310} Network error accessing ${i}`,"error"):a(`\u2753 Unknown error accessing ${i}`,"error");return!1}})}function ve(e,r,t){try{if(e.variantProperties&&e.variantProperties[r]!==void 0){const n=T(t);if(n!==void 0)return e.setProperties({[r]:n}),a(`\u{1F512} Applied sanitized variant property: ${r} = ${n}`,"info"),!0}return!1}catch(n){return a("Failed to apply variant property","error"),!1}}function $e(e,r){return e.map(t=>t.type==="text"?t.value:t.type==="key"&&D(r,t.value)||"").join("")}function Ae(e,r,t){const n=t[e.jsonKey];return n?$e(n.parts,r):D(r,e.jsonKey)}function a(e,r="info"){figma.ui.postMessage({type:"log",message:e,level:r})}function Se(i,o){return p(this,arguments,function*(e,r,t={},n){var b;const c=figma.currentPage.selection;if(c.length===0){a("No layers selected. Please select one or more frames, groups, component instances, or other containers.","warning");return}const s=ge(c);if(s.length===0){a("No valid containers found in selection. Please select frames, groups, component instances, or other container nodes.","warning");return}let u=0;const m=s.length;if(n){const d=Object.keys(n);a(`\u{1F4E6} Local images available for ${d.length} mapping(s): ${d.join(", ")}`,"info");for(const g of d){const C=Object.keys(n[g]);a(`   "${g}": ${C.length} file(s) - ${C.join(", ")}`,"info")}}else a("\u{1F4E6} No local images provided","info");a(`Found ${s.length} containers in selection. Starting to apply data...`,"info");for(let d=0;d<m;d++){const g=s[d],C=d%e.length,J=e[C];for(const f of r){const l=Ae(f,J,t);if(l==null){a(`Missing value for key "${f.jsonKey}" in data item ${d+1}`,"warning");continue}const w=j(g,f.layerName);if(!w){a(`Layer "${f.layerName}" not found in container "${g.name}"`,"warning");continue}if(typeof l=="string"&&le(l)){let y=fe(l);y=y.replace(/\.jpeg$/i,".jpg");const $=(b=n==null?void 0:n[f.jsonKey])==null?void 0:b[y];if(!$){const v=n!=null&&n[f.jsonKey]?Object.keys(n[f.jsonKey]).join(", "):"none";a(`\u{1F50D} Looking for "${y}" in mapping "${f.jsonKey}". Available files: ${v}`,"info")}$?(yield he(w,$))?a(`Applied local image "${y}" to layer "${f.layerName}" in "${g.name}"`,"info"):a(`Failed to apply local image "${y}" to layer "${f.layerName}" in "${g.name}"`,"error"):a(`\u26A0\uFE0F Local image file "${y}" not found for key "${f.jsonKey}"`,"warning")}else if(typeof l=="string"&&oe(l)){const y=f.jsonKey.toLowerCase(),$=y.includes("stroke"),v=y.includes("fill");$&&!v?L(w,l):v&&!$?F(w,l):(F(w,l),L(w,l))}else if(typeof l=="string"&&ce(l))(yield we(w,l))?a(`Applied image from URL to layer "${f.layerName}" in "${g.name}"`,"info"):a(`Failed to apply image from ${A(l)||"URL"} to layer "${f.layerName}" in "${g.name}"`,"error");else if(w.type==="TEXT")ue(w,String(l)),a(`Applied text "${l}" to layer "${f.layerName}" in "${g.name}"`,"info");else if(w.type==="INSTANCE"&&typeof l=="string"){const y=w,$=Object.keys(y.variantProperties||{});if($.length>0){const v=$.find(k=>k.toLowerCase()===f.layerName.toLowerCase()||f.layerName.toLowerCase().includes(k.toLowerCase()));v?ve(y,v,l)?a(`Applied variant property "${v}" = "${l}" in "${g.name}"`,"info"):a(`Failed to apply variant property "${v}" = "${l}" in "${g.name}"`,"error"):a(`No matching variant property found for "${f.layerName}" in "${g.name}"`,"warning")}}}u++}if(s.length>e.length){const d=Math.ceil(s.length/e.length);a(`\u{1F4C4} Data cycling: Used ${e.length} data items across ${s.length} containers (${d} cycles)`,"info")}else e.length>s.length?a(`\u{1F4C4} Data usage: Used ${s.length} of ${e.length} available data items`,"info"):a(`\u{1F4C4} Perfect match: ${s.length} containers with ${e.length} data items`,"info");a(`\u2705 Completed! Processed ${u} containers (frames, groups, instances) across ${c.length} selected items.`,"info")})}function be(i,o){return p(this,arguments,function*(e,r,t={},n){return Se(e,r,t,n)})}figma.showUI(__html__,{width:720,height:800,themeColors:!0});function Ce(e){return p(this,null,function*(){try{const t=((yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[]).filter(i=>i.name!==e.name);t.unshift(e);const n=t.slice(0,20);yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",n),figma.ui.postMessage({type:"config-saved",data:n,message:`Configuration "${e.name}" saved successfully`})}catch(r){figma.ui.postMessage({type:"storage-error",message:"Failed to save configuration"})}})}function R(){return p(this,null,function*(){try{const e=(yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[],r=ie(e),{cleanedConfigurations:t,migrationSummary:n}=r;n.migratedConfigs>0&&(yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",t),figma.ui.postMessage({type:"log",message:`Security migration: Cleaned ${n.migratedConfigs} configurations by removing API credentials`,level:"info"})),figma.ui.postMessage({type:"configs-loaded",data:t})}catch(e){figma.ui.postMessage({type:"storage-error",message:`Failed to load configurations: ${e instanceof Error?e.message:"Unknown error"}`})}})}function Me(e){return p(this,null,function*(){try{const t=((yield figma.clientStorage.getAsync("figmaJsonMapperConfigs"))||[]).filter(n=>n.name!==e);yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",t),figma.ui.postMessage({type:"config-deleted",data:t,message:`Configuration "${e}" deleted`})}catch(r){figma.ui.postMessage({type:"storage-error",message:"Failed to delete configuration"})}})}function ke(){return p(this,null,function*(){try{yield figma.clientStorage.setAsync("figmaJsonMapperConfigs",[]),figma.ui.postMessage({type:"configs-cleared",data:[],message:"All configurations cleared"})}catch(e){figma.ui.postMessage({type:"storage-error",message:"Failed to clear configurations"})}})}function H(e){V.add(e)}function Ne(e){return p(this,null,function*(){try{const{url:r,method:t="GET",headers:n={},requestId:i}=e,o=O(r);if(!o.isValid){figma.ui.postMessage({type:"api-fetch-error",requestId:i,error:o.error});return}const c=A(r);if(!c){figma.ui.postMessage({type:"api-fetch-error",requestId:i,error:"Unable to extract domain from URL"});return}if(!(yield K(c))&&(a(`Domain ${c} not approved. Requesting approval...`,"warning"),!(yield z(r,"API data fetching")))){figma.ui.postMessage({type:"api-fetch-error",requestId:i,error:`Domain ${c} was not approved by user`});return}const u=Object.assign({"User-Agent":"FigmaPlugin-Struct/1.0"},n);if(typeof fetch=="undefined")throw new Error("Fetch API is not available in this context");const m=yield fetch(r,{method:t,headers:u});if(!m)throw new Error("Response object is undefined");if(!m.ok)throw new Error(`HTTP ${m.status}: ${m.statusText}`);const b=m.headers&&m.headers.get&&m.headers.get("content-type")||"";let d;if(b.includes("application/json"))d=yield m.json();else{const g=yield m.text();try{d=JSON.parse(g)}catch(C){d=g}}figma.ui.postMessage({type:"api-fetch-success",requestId:i,data:d,contentType:b}),a(`Successfully fetched data from ${c}`,"info")}catch(r){const t=r instanceof Error?r.message:"Unknown error";figma.ui.postMessage({type:"api-fetch-error",requestId:e.requestId,error:t}),a(`API fetch failed: ${S(t)}`,"error")}})}function Ie(e){return p(this,null,function*(){try{const{key:r,value:t}=e;if(!r)throw new Error("Storage key is required");yield figma.clientStorage.setAsync(r,t),figma.ui.postMessage({type:"storage-save-response",key:r,success:!0}),a(`Secure storage save completed for key: ${r}`,"info")}catch(r){const t=r instanceof Error?r.message:"Storage save failed";figma.ui.postMessage({type:"storage-save-response",key:e.key,success:!1,error:t}),a(`Secure storage save failed: ${S(t)}`,"error")}})}function Pe(e){return p(this,null,function*(){try{const{key:r}=e;if(!r)throw new Error("Storage key is required");const t=yield figma.clientStorage.getAsync(r);figma.ui.postMessage({type:"storage-load-response",key:r,success:!0,value:t}),a(`Secure storage load completed for key: ${r}`,"info")}catch(r){const t=r instanceof Error?r.message:"Storage load failed";figma.ui.postMessage({type:"storage-load-response",key:e.key,success:!1,error:t,value:null}),a(`Secure storage load failed: ${S(t)}`,"error")}})}figma.ui.onmessage=e=>p(null,null,function*(){switch(e.type){case"apply-data":const{jsonData:r,mappings:t,valueBuilders:n,localImages:i}=e;yield be(r,t,n||{},i);break;case"save-config":yield Ce(e.data);break;case"load-configs":yield R();break;case"delete-config":yield Me(e.configName);break;case"clear-configs":yield ke();break;case"approve-domain":H(e.domain);break;case"domain-approval-response":h&&h.domain===e.domain&&(clearTimeout(h.timeoutId),e.approved?(H(e.domain),h.resolve(!0)):h.resolve(!1),h=null);break;case"fetch-api-data":yield Ne(e);break;case"storage-save-request":yield Ie(e);break;case"storage-load-request":yield Pe(e);break;case"close":figma.closePlugin();break;default:break}}),figma.on("selectionchange",()=>{figma.ui.postMessage({type:"selection-changed",selectionCount:figma.currentPage.selection.length})}),p(null,null,function*(){try{yield R(),a("\u{1F4CA} Storage initialized with basic security","info")}catch(e){a(`\u26A0\uFE0F Storage initialization failed: ${e instanceof Error?S(e.message):"Unknown error"}`,"warning"),yield R()}});try{figma.ui.postMessage({type:"selection-changed",selectionCount:figma.currentPage.selection.length})}catch(e){figma.ui.postMessage({type:"selection-changed",selectionCount:0})}
